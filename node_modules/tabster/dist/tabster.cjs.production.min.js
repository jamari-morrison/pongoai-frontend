"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("tslib"),t=require("keyborg"),i={Any:0,Accessible:1,Focusable:2},n={History:0,DeloserDefault:1,RootDefault:2,DeloserFirst:3,RootFirst:4},r={Invisible:0,PartiallyVisible:1,Visible:2},o={Both:0,Vertical:1,Horizontal:2,Grid:3},s={Unlimited:0,Limited:1,LimitedTrapFocus:2},a={__proto__:null,TabsterAttributeName:"data-tabster",TabsterDummyInputAttributeName:"data-tabster-dummy",DeloserEventName:"tabster:deloser",ModalizerEventName:"tabster:modalizer",MoverEventName:"tabster:mover",ObservedElementAccesibilities:i,RestoreFocusOrders:n,Visibilities:r,MoverDirections:o,GroupperTabbabilities:s};function u(e,t){var i;return null===(i=e.storageEntry(t))||void 0===i?void 0:i.tabster}function l(e,t,i){var n,r,o,s=i||e._noop?void 0:t.getAttribute("data-tabster"),a=e,u=a.storageEntry(t);if(s){if(s===(null===(n=null==u?void 0:u.attr)||void 0===n?void 0:n.string))return;try{var l=JSON.parse(s);if("object"!=typeof l)throw new Error("Value is not a JSON object, got '"+s+"'.");o={string:s,object:l}}catch(e){}}else if(!u)return;u||(u=e.storageEntry(t,!0)),u.tabster||(u.tabster={});for(var c=u.tabster||{},d=(null===(r=u.attr)||void 0===r?void 0:r.object)||{},_=(null==o?void 0:o.object)||{},f=0,h=Object.keys(d);f<h.length;f++)if(!_[y=h[f]]){if("root"===y){var v=c[y];v&&a.updateRoot(v,!0)}else if("modalizer"===y){var p=c.modalizer;a.updateModalizer&&p&&a.updateModalizer(p,!0)}switch(y){case"deloser":case"root":case"groupper":case"modalizer":case"mover":var m=c[y];m&&(m.dispose(),delete c[y]);break;case"observed":delete c[y],a.updateObserved&&a.updateObserved(t);break;case"focusable":case"outline":case"uncontrolled":delete c[y]}}for(var b=0,g=Object.keys(_);b<g.length;b++){var y;switch(y=g[b]){case"deloser":c.deloser?c.deloser.setProps(_.deloser):a.createDeloser&&(c.deloser=a.createDeloser(a,t,_.deloser));break;case"root":c.root?c.root.setProps(_.root):c.root=a.createRoot(a,t,_.root),a.updateRoot(c.root);break;case"modalizer":c.modalizer?c.modalizer.setProps(_.modalizer):a.createModalizer&&(c.modalizer=a.createModalizer(a,t,_.modalizer));break;case"focusable":c.focusable=_.focusable;break;case"groupper":c.groupper?c.groupper.setProps(_.groupper):a.createGroupper&&(c.groupper=a.createGroupper(a,t,_.groupper));break;case"mover":c.mover?c.mover.setProps(_.mover):a.createMover&&(c.mover=a.createMover(a,t,_.mover));break;case"observed":a.updateObserved&&(c.observed=_.observed,a.updateObserved(t));break;case"uncontrolled":c.uncontrolled=_.uncontrolled;break;case"outline":a.outline&&(c.outline=_.outline);break;default:console.error("Unknown key '"+y+"' in data-tabster attribute value.")}}o?u.attr=o:(0===Object.keys(c).length&&(delete u.tabster,delete u.attr),a.storageEntry(t,!1))}var c,d=function(){function e(){this._callbacks=[]}return e.prototype.dispose=function(){this._callbacks=[],delete this._val},e.prototype.subscribe=function(e){this._callbacks.indexOf(e)<0&&this._callbacks.push(e)},e.prototype.unsubscribe=function(e){var t=this._callbacks.indexOf(e);t>=0&&this._callbacks.splice(t,1)},e.prototype.setVal=function(e,t){this._val!==e&&(this._val=e,this._callCallbacks(e,t))},e.prototype.getVal=function(){return this._val},e.prototype.trigger=function(e,t){this._callCallbacks(e,t)},e.prototype._callCallbacks=function(e,t){this._callbacks.forEach((function(i){return i(e,t)}))},e}(),_=function(i){function n(e){var n=i.call(this)||this;return n._onChange=function(e){n.setVal(e,void 0)},n._keyborg=t.createKeyborg(e()),n._keyborg.subscribe(n._onChange),n}return e.__extends(n,i),n.prototype.dispose=function(){i.prototype.dispose.call(this),this._keyborg&&(this._keyborg.unsubscribe(this._onChange),t.disposeKeyborg(this._keyborg),delete this._keyborg)},n.dispose=function(e){e.dispose()},n.setVal=function(e,t){var i;null===(i=e._keyborg)||void 0===i||i.setVal(t)},n.prototype.isNavigatingWithKeyboard=function(){var e;return!!(null===(e=this._keyborg)||void 0===e?void 0:e.isNavigatingWithKeyboard())},n}(d),f="undefined"!=typeof DOMRect?DOMRect:function(){return function(e,t,i,n){this.left=e||0,this.top=t||0,this.right=(e||0)+(i||0),this.bottom=(t||0)+(n||0)}}(),h=0;try{document.createTreeWalker(document,NodeFilter.SHOW_ELEMENT),c=!1}catch(e){c=!0}function v(e){var t=e(),i=t.__tabsterInstanceContext;return i||(t.__tabsterInstanceContext=i={elementByUId:{},basics:{Promise:t.Promise||void 0,WeakRef:t.WeakRef||void 0},containerBoundingRectCache:{},lastContainerBoundingRectCacheId:0,fakeWeakRefs:[],fakeWeakRefsStarted:!1}),i}var p=function(){function e(e){this._target=e}return e.prototype.deref=function(){return this._target},e.cleanup=function(e,t){return!e._target||!(!t&&R(e._target.ownerDocument,e._target))&&(delete e._target,!0)},e}(),m=function(){function e(e,t,i){var n,r=v(e);r.WeakRef?n=new r.WeakRef(t):(n=new p(t),r.fakeWeakRefs.push(n)),this._ref=n,this._data=i}return e.prototype.get=function(){var e,t=this._ref;return t&&((e=t.deref())||delete this._ref),e},e.prototype.getData=function(){return this._data},e}();function b(e,t){var i=v(e);i.fakeWeakRefs=i.fakeWeakRefs.filter((function(e){return!p.cleanup(e,t)}))}function g(e,t,i){if(t.nodeType===Node.ELEMENT_NODE)return e.createTreeWalker(t,NodeFilter.SHOW_ELEMENT,c?i:{acceptNode:i},!1)}function y(e,t){var i=t.__tabsterCacheId,n=v(e),r=i?n.containerBoundingRectCache[i]:void 0;if(r)return r.rect;var o=t.ownerDocument&&t.ownerDocument.documentElement;if(!o)return new f;var s=0,a=0,u=o.clientWidth,l=o.clientHeight;if(t!==o){var c=t.getBoundingClientRect();s=Math.max(s,c.left),a=Math.max(a,c.top),u=Math.min(u,c.right),l=Math.min(l,c.bottom)}var d=new f(s<u?s:-1,a<l?a:-1,s<u?u-s:0,a<l?l-a:0);return i||(i="r-"+ ++n.lastContainerBoundingRectCacheId,t.__tabsterCacheId=i),n.containerBoundingRectCache[i]={rect:d,element:t},n.containerBoundingRectCacheTimer||(n.containerBoundingRectCacheTimer=window.setTimeout((function(){n.containerBoundingRectCacheTimer=void 0;for(var e=0,t=Object.keys(n.containerBoundingRectCache);e<t.length;e++)delete n.containerBoundingRectCache[t[e]].element.__tabsterCacheId;n.containerBoundingRectCache={}}),50)),d}function w(e,t){var i=F(t);if(i){var n=y(e,i),r=t.getBoundingClientRect();return r.top>=n.top&&r.bottom<=n.bottom}return!1}function T(e,t,i){void 0===i&&(i=0);var n=F(t);if(n){var o=y(e,n),s=t.getBoundingClientRect();return s.left>o.right||s.top>o.bottom||s.bottom<o.top||s.right<o.left?r.Invisible:s.top+i>=o.top&&s.top<=o.bottom&&s.bottom>=o.top&&s.bottom-i<=o.bottom&&s.left+i>=o.left&&s.left<=o.right&&s.right>=o.left&&s.right-i<=o.right?r.Visible:r.PartiallyVisible}return r.Invisible}function E(e,t,i){var n=F(t);if(n){var r=y(e,n),o=t.getBoundingClientRect();n.scrollTop+=i?o.top-r.top:o.bottom-r.bottom}}function F(e){var t=e.ownerDocument;if(t){for(var i=e.parentElement;i;i=i.parentElement)if(i.scrollWidth>i.clientWidth||i.scrollHeight>i.clientHeight)return i;return t.documentElement}return null}function D(e){return!!e.__shouldIgnoreFocus}function I(e){var t=new Uint32Array(4);if(e.crypto&&e.crypto.getRandomValues)e.crypto.getRandomValues(t);else if(e.msCrypto&&e.msCrypto.getRandomValues)e.msCrypto.getRandomValues(t);else for(var i=0;i<t.length;i++)t[i]=4294967295*Math.random();var n=[];for(i=0;i<t.length;i++)n.push(t[i].toString(36));return n.push("|"),n.push((++h).toString(36)),n.push("|"),n.push(Date.now().toString(36)),n.join("")}function C(e,t){var i=v(e),n=t.__tabsterElementUID;return n||(n=t.__tabsterElementUID=I(e())),!i.elementByUId[n]&&R(t.ownerDocument,t)&&(i.elementByUId[n]=new m(e,t)),n}function k(e){var t=e.__tabsterCrossOriginWindowUID;return t||(t=e.__tabsterCrossOriginWindowUID=I(e)),t}function O(e,t){for(var i=v(e),n=0,r=Object.keys(i.elementByUId);n<r.length;n++){var o=r[n],s=i.elementByUId[o],a=s&&s.get();a&&t&&!t.contains(a)||delete i.elementByUId[o]}}function R(e,t){var i;return!!(null===(i=null==e?void 0:e.body)||void 0===i?void 0:i.contains(t))}function N(e,t){var i=e.matches||e.matchesSelector||e.msMatchesSelector||e.webkitMatchesSelector;return i&&i.call(e,t)}function x(e){var t=v(e);if(t.basics.Promise)return t.basics.Promise;throw new Error("No Promise defined.")}var A=0,M=function(){function t(t,i,n){var r=t.getWindow;this._tabster=t,this._element=new m(r,i),this._props=e.__assign({},n),this.id="i"+ ++A}return t.prototype.getElement=function(){return this._element.get()},t.prototype.getProps=function(){return this._props},t.prototype.setProps=function(t){this._props=e.__assign({},t)},t}(),U=function(){function e(e,t){var i,n=this;this._focusIn=function(e){n.onFocusIn&&n.input&&n.onFocusIn(n)},this._focusOut=function(e){n.shouldMoveOut=!1,n.onFocusOut&&n.input&&n.onFocusOut(n),n._isPhantom&&n.dispose()};var r=e().document.createElement("div");r.tabIndex=0,r.setAttribute("role","none"),r.setAttribute("data-tabster-dummy",""),r.setAttribute("aria-hidden","true");var o=r.style;o.position="fixed",o.width=o.height="1px",o.left=o.top="-100500px",o.opacity="0",o.zIndex="-1",r.__shouldIgnoreFocus=!0,this.input=r,this.isFirst=t.isFirst,this._isPhantom=null!==(i=t.isPhantom)&&void 0!==i&&i,r.addEventListener("focusin",this._focusIn),r.addEventListener("focusout",this._focusOut)}return e.prototype.dispose=function(){var e,t=this.input;t&&(delete this.onFocusIn,delete this.onFocusOut,delete this.input,t.removeEventListener("focusin",this._focusIn),t.removeEventListener("focusout",this._focusOut),null===(e=t.parentElement)||void 0===e||e.removeChild(t))},e}(),P=function(){function e(e,t){var i=this;this.moveOutWithDefaultAction=function(e){var t=i.firstDummy,n=i.lastDummy;(null==t?void 0:t.input)&&(null==n?void 0:n.input)&&(e?(t.shouldMoveOut=!0,t.input.focus()):(n.shouldMoveOut=!0,n.input.focus()))};var n=e.getWindow;this.firstDummy=new U(n,{isFirst:!0}),this.lastDummy=new U(n,{isFirst:!1}),this._element=t,this._addDummyInputs(),"undefined"!=typeof process&&"test"===process.env.NODE_ENV||this._observeMutations(n)}return e.prototype.dispose=function(){var e;this.firstDummy.dispose(),this.lastDummy.dispose(),null===(e=this._unobserve)||void 0===e||e.call(this)},e.prototype._addDummyInputs=function(){var e,t,i=this._element.get(),n=null===(e=this.firstDummy)||void 0===e?void 0:e.input,r=null===(t=this.lastDummy)||void 0===t?void 0:t.input;if(i&&n&&r){i.lastElementChild!==r&&i.appendChild(r);var o=i.firstElementChild;o&&o!==n&&i.insertBefore(n,o)}},e.prototype._observeMutations=function(e){var t=this;if(!this._unobserve){var i=new MutationObserver((function(){t._addDummyInputs()})),n=this._element.get();n&&(i.observe(n,{childList:!0}),this._unobserve=function(){i.disconnect()})}},e}();function z(e){for(var t=null,i=e.lastElementChild;i;i=i.lastElementChild)t=i;return t}function S(e,t,i){var n=document.createEvent("HTMLEvents");return n.initEvent(t,!0,!0),n.details=i,e.dispatchEvent(n),!n.defaultPrevented}var W=function(t){function i(e,i,n){var r=t.call(this,e,i)||this;return r.setTabbable=function(e){var t=e?0:-1;r.firstDummy.input&&(r.firstDummy.input.tabIndex=t),r.lastDummy.input&&(r.lastDummy.input.tabIndex=t)},r._onDummyInputFocus=function(e){var t;if(e.shouldMoveOut)r._setFocused(!1,!0);else{_.setVal(r._tabster.keyboardNavigation,!0);var i=r._element.get();if(i&&(r._setFocused(!0,!0),e.isFirst?r._tabster.focusedElement.focusFirst({container:i}):r._tabster.focusedElement.focusLast({container:i})))return;null===(t=e.input)||void 0===t||t.blur()}},r._tabster=e,r._setFocused=n,r.firstDummy.onFocusIn=r._onDummyInputFocus,r.lastDummy.onFocusIn=r._onDummyInputFocus,r}return e.__extends(i,t),i}(P),L=function(t){function i(e,i,n){var r=t.call(this,e,i,n)||this;return r._isFocused=!1,r._setFocused=function(e,t){if(r._setFocusedTimer&&(r._tabster.getWindow().clearTimeout(r._setFocusedTimer),delete r._setFocusedTimer),r._isFocused!==e){var i=r._element.get();i&&(e?(r._isFocused=!0,S(r._tabster.root.eventTarget,"focus",{element:i,fromAdjacent:t})):r._setFocusedTimer=r._tabster.getWindow().setTimeout((function(){delete r._setFocusedTimer,r._isFocused=!1,S(r._tabster.root.eventTarget,"blur",{element:i,fromAdjacent:t})}),0))}},r._onFocus=function(e){var t,i;if(e){var n=V.getTabsterContext(r._tabster,e);if(n&&r._setFocused(n.root.getElement()===r._element.get()),!n||n.uncontrolled)return void(null===(t=r._dummyManager)||void 0===t||t.setTabbable(!1))}else r._setFocused(!1);null===(i=r._dummyManager)||void 0===i||i.setTabbable(!0)},r.uid=C(e.getWindow,i),e.controlTab&&(r._dummyManager=new W(e,r._element,r._setFocused)),e.focusedElement.subscribe(r._onFocus),r._add(),r}return e.__extends(i,t),i.prototype.dispose=function(){var e;this._setFocusedTimer&&(this._tabster.getWindow().clearTimeout(this._setFocusedTimer),delete this._setFocusedTimer),null===(e=this._dummyManager)||void 0===e||e.dispose(),this._remove()},i.prototype.moveOutWithDefaultAction=function(e){var t;null===(t=this._dummyManager)||void 0===t||t.moveOutWithDefaultAction(e)},i.prototype._add=function(){},i.prototype._remove=function(){},i}(M),V=function(){function e(e,t){var i=this;this.rootById={},this._init=function(){i._initTimer=void 0},this._tabster=e,this._win=e.getWindow,this._initTimer=this._win().setTimeout(this._init,0),this._autoRoot=t,this.eventTarget=new EventTarget}return e.prototype.dispose=function(){var e=this._win();this._autoRootInstance&&(this._autoRootInstance.dispose(),delete this._autoRootInstance,delete this._autoRoot),this._initTimer&&(e.clearTimeout(this._initTimer),this._initTimer=void 0),this.rootById={}},e.dispose=function(e){e.dispose()},e.getRootByUId=function(e,t){var i=e().__tabsterInstance;return i&&i.root.rootById[t]},e.getTabsterContext=function(e,t,i){var n;if(void 0===i&&(i={}),t.ownerDocument){for(var r,o,s,a,l,c,d,_=i.checkRtl,f=t;f&&(!r||_);){var h=u(e,f);if(_&&void 0===c){var v=f.dir;v&&(c="rtl"===v.toLowerCase())}if(h){h.uncontrolled&&(d=f);var p=h.groupper,m=h.mover;!s&&p&&(s=p),!a&&m&&(a=m,l=!!s),!o&&h.modalizer&&(o=h.modalizer),h.root&&(r=h.root),f=f.parentElement}else f=f.parentElement}if(!r){var b=e.root,g=b._autoRoot;if(g&&!b._autoRootInstance){var y=null===(n=t.ownerDocument)||void 0===n?void 0:n.body;y&&(b._autoRootInstance=new L(b._tabster,y,g))}r=b._autoRootInstance}return r?{root:r,modalizer:o,groupper:s,mover:a,isGroupperFirst:l,isRtl:_?!!c:void 0,uncontrolled:d}:void 0}},e.onRoot=function(e,t,i){i?delete e.rootById[t.uid]:e.rootById[t.uid]=t},e.createRoot=function(e,t,i){return new L(e,t,i)},e}(),B=function(){return function(){}}(),K=function(t){function i(e,i){var n=t.call(this)||this;return n.uid=i.uid,n._tabster=e,n._deloser=i,n}return e.__extends(i,t),i.prototype.belongsTo=function(e){return e===this._deloser},i.prototype.unshift=function(e){this._deloser.unshift(e)},i.prototype.focusAvailable=function(){return e.__awaiter(this,void 0,void 0,(function(){var t;return e.__generator(this,(function(e){return[2,!!(t=this._deloser.findAvailable())&&this._tabster.focusedElement.focus(t)]}))}))},i.prototype.resetFocus=function(){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){return[2,x(this._tabster.getWindow).resolve(this._deloser.resetFocus())]}))}))},i}(B),j=function(){function e(e,t){this._history=[],this._tabster=e,this.rootUId=t}return e.prototype.getLength=function(){return this._history.length},e.prototype.removeDeloser=function(e){this._history=this._history.filter((function(t){return!t.belongsTo(e)}))},e.prototype.hasDeloser=function(e){return this._history.some((function(t){return t.belongsTo(e)}))},e}(),H=function(t){function i(){return null!==t&&t.apply(this,arguments)||this}return e.__extends(i,t),i.prototype.unshiftToDeloser=function(e,t){for(var i,n=0;n<this._history.length;n++)if(this._history[n].belongsTo(e)){i=this._history[n],this._history.splice(n,1);break}i||(i=new K(this._tabster,e)),i.unshift(t),this._history.unshift(i),this._history.splice(10,this._history.length-10)},i.prototype.focusAvailable=function(t){return e.__awaiter(this,void 0,void 0,(function(){var i,n,r,o,s;return e.__generator(this,(function(e){switch(e.label){case 0:i=!!t,n=0,r=this._history,e.label=1;case 1:return n<r.length?(o=r[n],t&&o.belongsTo(t)&&(i=!1),(s=!i)?[4,o.focusAvailable()]:[3,3]):[3,5];case 2:s=e.sent(),e.label=3;case 3:if(s)return[2,!0];e.label=4;case 4:return n++,[3,1];case 5:return[2,!1]}}))}))},i.prototype.resetFocus=function(t){return e.__awaiter(this,void 0,void 0,(function(){var i,n,r,o,s,a,u;return e.__generator(this,(function(e){switch(e.label){case 0:for(i=!!t,n={},r=0,o=this._history;r<o.length;r++)s=o[r],t&&s.belongsTo(t)&&(i=!1),i||n[s.uid]||(n[s.uid]=s);a=0,u=Object.keys(n),e.label=1;case 1:return a<u.length?[4,n[u[a]].resetFocus()]:[3,4];case 2:if(e.sent())return[2,!0];e.label=3;case 3:return a++,[3,1];case 4:return[2,!1]}}))}))},i}(j),q=function(){function t(e){this._history=[],this._tabster=e}return t.prototype.dispose=function(){this._history=[]},t.prototype.process=function(e){var t,i=this,n=V.getTabsterContext(this._tabster,e),r=n&&n.root.uid,o=Y.getDeloser(this._tabster,e);if(r&&o){var s=this.make(r,(function(){return new H(i._tabster,r)}));return n&&n.modalizer&&!(null===(t=n.modalizer)||void 0===t?void 0:t.isActive())||s.unshiftToDeloser(o,e),o}},t.prototype.make=function(e,t){for(var i,n=0;n<this._history.length;n++){var r=this._history[n];if(r.rootUId===e){i=r,this._history.splice(n,1);break}}return i||(i=t()),this._history.unshift(i),this._history.splice(10,this._history.length-10),i},t.prototype.removeDeloser=function(e){this._history.forEach((function(t){t.removeDeloser(e)})),this._history=this._history.filter((function(e){return e.getLength()>0}))},t.prototype.focusAvailable=function(t){return e.__awaiter(this,void 0,void 0,(function(){var i,n,r,o,s;return e.__generator(this,(function(e){switch(e.label){case 0:i=!!t,n=0,r=this._history,e.label=1;case 1:return n<r.length?(o=r[n],t&&o.hasDeloser(t)&&(i=!1),(s=!i)?[4,o.focusAvailable(t)]:[3,3]):[3,5];case 2:s=e.sent(),e.label=3;case 3:if(s)return[2,!0];e.label=4;case 4:return n++,[3,1];case 5:return[2,!1]}}))}))},t.prototype.resetFocus=function(t){return e.__awaiter(this,void 0,void 0,(function(){var i,n,r,o,s;return e.__generator(this,(function(e){switch(e.label){case 0:i=!!t,n=0,r=this._history,e.label=1;case 1:return n<r.length?(o=r[n],t&&o.hasDeloser(t)&&(i=!1),(s=!i)?[4,o.resetFocus(t)]:[3,3]):[3,5];case 2:s=e.sent(),e.label=3;case 3:if(s)return[2,!0];e.label=4;case 4:return n++,[3,1];case 5:return[2,!1]}}))}))},t}();function G(e,t,i){var n=[],r=/(:|\.|\[|\]|,|=|@)/g;e.id&&n.push("#"+e.id.replace(r,"\\$1")),!1!==t&&e.className&&e.className.split(" ").forEach((function(e){(e=e.trim())&&n.push("."+e.replace(r,"\\$1"))}));var o,s=0;if(!1!==i&&0===n.length){for(o=e;o;)s++,o=o.previousElementSibling;n.unshift(":nth-child("+s+")")}return n.unshift(e.tagName.toLowerCase()),n.join("")}var J=function(t){function i(e,i,n,r){var o=t.call(this,e,i,r)||this;return o._isActive=!1,o._history=[[]],o._snapshotIndex=0,o.isActive=function(){return o._isActive},o.setSnapshot=function(e){o._snapshotIndex=e,o._history.length>e+1&&o._history.splice(e+1,o._history.length-e-1),o._history[e]||(o._history[e]=[])},o.focusFirst=function(){var e=o._element.get();return!!e&&o._tabster.focusedElement.focusFirst({container:e})},o.focusDefault=function(){var e=o._element.get();return!!e&&o._tabster.focusedElement.focusDefault(e)},o.resetFocus=function(){var e=o._element.get();return!!e&&o._tabster.focusedElement.resetFocus(e)},o.clearHistory=function(e){var t=o._element.get();o._history[o._snapshotIndex]=t?o._history[o._snapshotIndex].filter((function(i){var n=i.get();return!(!n||!e)&&t.contains(n)})):[]},o.uid=C(e.getWindow,i),o._onDispose=n,o}return e.__extends(i,t),i.prototype.dispose=function(){this._remove(),this._onDispose(this),this._isActive=!1,this._snapshotIndex=0,this._props={},this._history=[]},i.prototype.setActive=function(e){this._isActive=e},i.prototype.getActions=function(){return{focusDefault:this.focusDefault,focusFirst:this.focusFirst,resetFocus:this.resetFocus,clearHistory:this.clearHistory,setSnapshot:this.setSnapshot,isActive:this.isActive}},i.prototype.unshift=function(e){var t=this._history[this._snapshotIndex];for((t=this._history[this._snapshotIndex]=t.filter((function(t){var i=t.get();return i&&i!==e}))).unshift(new m(this._tabster.getWindow,e,function(e){if(R(e.ownerDocument,e)){for(var t=[G(e)],i=e.parentElement;i;){var n="BODY"===i.tagName;if(t.unshift(G(i,!1,!n)),n)break;i=i.parentElement}return t.join(" ")}}(e)));t.length>10;)t.pop()},i.prototype.findAvailable=function(){var e=this._element.get();if(!e||!this._tabster.focusable.isVisible(e))return null;var t=this._props.restoreFocusOrder,i=null,r=V.getTabsterContext(this._tabster,e);if(!r)return null;var o=r.root,s=o.getElement();if(!s)return null;if(void 0===t&&(t=o.getProps().restoreFocusOrder),t===n.RootDefault&&(i=this._tabster.focusable.findDefault({container:s})),i||t!==n.RootFirst||(i=this._findFirst(s)),i)return i;var a=this._findInHistory(),u=this._tabster.focusable.findDefault({container:e}),l=this._findFirst(e);return a&&t===n.History?a:u&&t===n.DeloserDefault?u:l&&t===n.DeloserFirst?l:u||a||l||null},i.prototype.customFocusLostHandler=function(e){return S(e,"tabster:deloser",this.getActions())},i.prototype._findInHistory=function(){var e=this._history[this._snapshotIndex].slice(0);this.clearHistory(!0);for(var t=0;t<e.length;t++){var i=e[t],n=i.get(),r=this._element.get();if(n&&r&&r.contains(n)){if(this._tabster.focusable.isFocusable(n))return n}else if(!this._props.noSelectorCheck){var o=i.getData();if(o&&r){var s=void 0;try{s=r.ownerDocument.querySelectorAll(o)}catch(n){continue}for(var a=0;a<s.length;a++){var u=s[a];if(u&&this._tabster.focusable.isFocusable(u))return u}}}}return null},i.prototype._findFirst=function(e){if(this._tabster.keyboardNavigation.isNavigatingWithKeyboard()){var t=this._tabster.focusable.findFirst({container:e});if(t)return t}return null},i.prototype._remove=function(){},i}(M),Y=function(){function t(e,t){var i=this;this._inDeloser=!1,this._isRestoringFocus=!1,this._isPaused=!1,this._init=function(){i._initTimer=void 0,i._tabster.focusedElement.subscribe(i._onFocus)},this._onFocus=function(e){if(i._restoreFocusTimer&&(i._win().clearTimeout(i._restoreFocusTimer),i._restoreFocusTimer=void 0),e){var t=i._history.process(e);t?i._activate(t):i._deactivate()}else i._scheduleRestoreFocus()},this._onDeloserDispose=function(e){i._history.removeDeloser(e),e.isActive()&&i._scheduleRestoreFocus()},this._tabster=e,this._win=e.getWindow,this._history=new q(e),this._initTimer=this._win().setTimeout(this._init,0);var n=null==t?void 0:t.autoDeloser;n&&(this._autoDeloser=n)}return t.prototype.dispose=function(){var e=this._win();this._initTimer&&(e.clearTimeout(this._initTimer),this._initTimer=void 0),this._restoreFocusTimer&&(e.clearTimeout(this._restoreFocusTimer),this._restoreFocusTimer=void 0),this._autoDeloserInstance&&(this._autoDeloserInstance.dispose(),delete this._autoDeloserInstance,delete this._autoDeloser),this._tabster.focusedElement.unsubscribe(this._onFocus),this._history.dispose(),delete this._curDeloser},t.dispose=function(e){e.dispose()},t.prototype.getActions=function(e){for(var t=e;t;t=t.parentElement){var i=u(this._tabster,t);if(i&&i.deloser)return i.deloser.getActions()}},t.prototype.pause=function(){this._isPaused=!0,this._restoreFocusTimer&&(this._win().clearTimeout(this._restoreFocusTimer),this._restoreFocusTimer=void 0)},t.prototype.resume=function(e){this._isPaused=!1,e&&this._scheduleRestoreFocus()},t.prototype._activate=function(e){var t=this._curDeloser;t!==e&&(this._inDeloser=!0,null==t||t.setActive(!1),e.setActive(!0),this._curDeloser=e)},t.prototype._deactivate=function(){var e;this._inDeloser=!1,null===(e=this._curDeloser)||void 0===e||e.setActive(!1),this._curDeloser=void 0},t.prototype._scheduleRestoreFocus=function(t){var i=this;if(!this._isPaused&&!this._isRestoringFocus){var n=function(){return e.__awaiter(i,void 0,void 0,(function(){var i,n,r;return e.__generator(this,(function(e){switch(e.label){case 0:if(this._restoreFocusTimer=void 0,i=this._tabster.focusedElement.getLastFocusedElement(),!t&&(this._isRestoringFocus||!this._inDeloser||(null==i?void 0:i.offsetParent)))return[2];if(n=this._curDeloser){if(i&&n.customFocusLostHandler(i))return[2];if((r=n.findAvailable())&&this._tabster.focusedElement.focus(r))return[2]}return this._deactivate(),this._isRestoringFocus=!0,[4,this._history.focusAvailable(null)];case 1:return e.sent()?[3,3]:[4,this._history.resetFocus(null)];case 2:e.sent(),e.label=3;case 3:return this._isRestoringFocus=!1,[2]}}))}))};t?n():this._restoreFocusTimer=this._win().setTimeout(n,100)}},t.getDeloser=function(e,t){for(var i,n=t;n;n=n.parentElement){var r=u(e,n);if(r&&r.deloser)return r.deloser}var o=e.deloser&&e.deloser;if(o){if(o._autoDeloserInstance)return o._autoDeloserInstance;var s=o._autoDeloser;if(!o._autoDeloserInstance&&s){var a=null===(i=t.ownerDocument)||void 0===i?void 0:i.body;a&&(o._autoDeloserInstance=new J(e,a,e.deloser._onDeloserDispose,s))}return o._autoDeloserInstance}},t.getHistory=function(e){return e._history},t.forceRestoreFocus=function(e){e._scheduleRestoreFocus(!0)},t.createDeloser=function(e,t,i){var n,r=new J(e,t,e.deloser._onDeloserDispose,i);return t.contains(null!==(n=e.focusedElement.getFocusedElement())&&void 0!==n?n:null)&&e.deloser._activate(r),r},t}(),X=function(t){function i(e,i,n){var r=t.call(this)||this;return r._deloser=i,r._transactions=n,r}return e.__extends(i,t),i.prototype.belongsTo=function(e){return e.deloserUId===this._deloser.deloserUId},i.prototype.focusAvailable=function(){return e.__awaiter(this,void 0,void 0,(function(){var t;return e.__generator(this,(function(i){return t=e.__assign(e.__assign({},this._deloser),{reset:!1}),[2,this._transactions.beginTransaction(ne,t).then((function(e){return!!e}))]}))}))},i.prototype.resetFocus=function(){return e.__awaiter(this,void 0,void 0,(function(){var t;return e.__generator(this,(function(i){return t=e.__assign(e.__assign({},this._deloser),{reset:!0}),[2,this._transactions.beginTransaction(ne,t).then((function(e){return!!e}))]}))}))},i}(B),$=function(t){function i(e,i,n){var r=t.call(this,e,i)||this;return r._transactions=n,r}return e.__extends(i,t),i.prototype.unshift=function(e){for(var t,i=0;i<this._history.length;i++)if(this._history[i].belongsTo(e)){t=this._history[i],this._history.splice(i,1);break}t||(t=new X(this._tabster,e,this._transactions)),this._history.unshift(t),this._history.splice(10,this._history.length-10)},i.prototype.focusAvailable=function(){return e.__awaiter(this,void 0,void 0,(function(){var t,i;return e.__generator(this,(function(e){switch(e.label){case 0:t=0,i=this._history,e.label=1;case 1:return t<i.length?[4,i[t].focusAvailable()]:[3,4];case 2:if(e.sent())return[2,!0];e.label=3;case 3:return t++,[3,1];case 4:return[2,!1]}}))}))},i.prototype.resetFocus=function(){return e.__awaiter(this,void 0,void 0,(function(){var t,i;return e.__generator(this,(function(e){switch(e.label){case 0:t=0,i=this._history,e.label=1;case 1:return t<i.length?[4,i[t].resetFocus()]:[3,4];case 2:if(e.sent())return[2,!0];e.label=3;case 3:return t++,[3,1];case 4:return[2,!1]}}))}))},i}(j),Q=function(){function t(e,t,i,n,r,o,s,a){var u,l=this;this._inProgress={},this._isDone=!1,this._isSelfResponding=!1,this._sentCount=0,this.tabster=e,this.owner=t,this.ownerId=k(t()),this.id=I(t()),this.beginData=n,this._knownTargets=i,this._sentTo=o||((u={})[this.ownerId]=!0,u),this.targetId=s,this.sendUp=a,this.timeout=r,this._promise=new(x(t))((function(e,t){l._resolve=e,l._reject=t}))}return t.prototype.getTargets=function(e){var t,i,n;return"up"===this.targetId?this.sendUp?((t={}).up={send:this.sendUp},t):null:this.targetId?e[this.targetId]?((i={})[this.targetId]={send:e[this.targetId].send},i):null:0===Object.keys(e).length&&this.sendUp?((n={}).up={send:this.sendUp},n):Object.keys(e).length>0?e:null},t.prototype.begin=function(t){var i=this,n=this.getTargets(this._knownTargets),r=e.__assign({},this._sentTo);if(n)for(var o=0,s=Object.keys(n);o<s.length;o++)r[c=s[o]]=!0;var a={transaction:this.id,type:this.type,isResponse:!1,timestamp:Date.now(),owner:this.ownerId,sentto:r,timeout:this.timeout,beginData:this.beginData};if(this.targetId&&(a.target=this.targetId),t&&(this._isSelfResponding=!0,t(a).then((function(e){i._isSelfResponding=!1,void 0!==e&&(i.endData||(i.endData=e)),(i.endData||0===i._sentCount)&&i.end()}))),n)for(var u=0,l=Object.keys(n);u<l.length;u++){var c;(c=l[u])in this._sentTo||this._send(n[c].send,c,a)}return 0!==this._sentCount||this._isSelfResponding||this.end(),this._promise},t.prototype._send=function(e,t,i){void 0===this._inProgress[t]&&(this._inProgress[t]=!0,this._sentCount++,e(i))},t.prototype.end=function(e){this._isDone||(this._isDone=!0,void 0===this.endData&&e?this._reject&&this._reject(e):this._resolve&&this._resolve(this.endData))},t.prototype.onResponse=function(e){var t=e.endData;void 0===t||this.endData||(this.endData=t);var i="up"===e.target?"up":e.owner;this._inProgress[i]&&(this._inProgress[i]=!1,this._sentCount--,(this.endData||0===this._sentCount&&!this._isSelfResponding)&&this.end())},t}(),Z=function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e.type=1,e}return e.__extends(i,t),i.shouldForward=function(){return!1},i.makeResponse=function(t){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){return[2,{isNavigatingWithKeyboard:t.keyboardNavigation.isNavigatingWithKeyboard()}]}))}))},i}(Q),ee=function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e.type=2,e}return e.__extends(i,t),i.shouldForward=function(e,t,i){var n=ie.findElement(e,i,t.beginData);return!n||!e.focusable.isFocusable(n)},i.makeResponse=function(t,i,n,r,o,s){return e.__awaiter(this,void 0,void 0,(function(){var r,o;return e.__generator(this,(function(e){switch(e.label){case 0:return r=ie.findElement(t,n,i.beginData),(o=!!r&&t.focusedElement.focus(r))?[3,2]:[4,s];case 1:o=!!e.sent(),e.label=2;case 2:return[2,o]}}))}))},i.shouldSelfRespond=function(){return!0},i}(Q),te=function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e.type=3,e}return e.__extends(i,t),i.shouldSelfRespond=function(e,t){return 4!==t.state&&5!==t.state},i.makeResponse=function(t,n,r,o,s,a,u){return e.__awaiter(this,void 0,void 0,(function(){var r,o;return e.__generator(this,(function(e){if(o=n.beginData,(r=n.timestamp)&&o)switch(o.state){case 1:return[2,i._makeFocusedResponse(t,r,o,s,u)];case 2:return[2,i._makeBlurredResponse(t,r,o,s.ctx)];case 3:return[2,i._makeObservedResponse(t,o)];case 4:return[2,i._makeDeadWindowResponse(t,o,s,a)];case 5:return[2,i._makeKeyboardNavigationResponse(t,s.ctx,o.isNavigatingWithKeyboard)];case 6:return[2,i._makeOutlineResponse(t,s.ctx,o.outline)]}return[2,!0]}))}))},i.createElement=function(e,t){return t.uid?new se(e,t.uid,t.ownerUId,t.id,t.rootUId,t.observedName,t.observedDetails):null},i._makeFocusedResponse=function(t,n,r,o,s){return e.__awaiter(this,void 0,void 0,(function(){var a,u,l,c;return e.__generator(this,(function(e){return a=i.createElement(t,r),r&&r.ownerUId&&a&&(o.ctx.focusOwner=r.ownerUId,o.ctx.focusOwnerTimestamp=n,!s&&r.rootUId&&r.deloserUId&&(u=t.deloser)&&(l=Y.getHistory(u),c={ownerUId:r.ownerUId,deloserUId:r.deloserUId,rootUId:r.rootUId},l.make(r.rootUId,(function(){return new $(t,c.rootUId,o)})).unshift(c)),ae.setVal(t.crossOrigin.focusedElement,a,{isFocusedProgrammatically:r.isFocusedProgrammatically})),[2,!0]}))}))},i._makeBlurredResponse=function(t,i,n,r){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){return n&&(n.ownerUId===r.focusOwner||n.force)&&(!r.focusOwnerTimestamp||r.focusOwnerTimestamp<i)&&ae.setVal(t.crossOrigin.focusedElement,void 0,{}),[2,!0]}))}))},i._makeObservedResponse=function(t,n){return e.__awaiter(this,void 0,void 0,(function(){var r,o;return e.__generator(this,(function(e){return r=n.observedName,o=i.createElement(t,n),r&&o&&ue.trigger(t.crossOrigin.observedElement,o,{name:r,details:n.observedDetails}),[2,!0]}))}))},i._makeDeadWindowResponse=function(t,i,n,r){return e.__awaiter(this,void 0,void 0,(function(){var o;return e.__generator(this,(function(e){return(o=i&&i.ownerUId)&&n.removeTarget(o),[2,r.then((function(){if(o===n.ctx.focusOwner){var e=t.deloser;e&&Y.forceRestoreFocus(e)}return!0}))]}))}))},i._makeKeyboardNavigationResponse=function(t,i,n){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){return void 0!==n&&t.keyboardNavigation.isNavigatingWithKeyboard()!==n&&(i.ignoreKeyboardNavigationStateUpdate=!0,_.setVal(t.keyboardNavigation,n),i.ignoreKeyboardNavigationStateUpdate=!1),[2,!0]}))}))},i._makeOutlineResponse=function(t,i,n){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){return i.origOutlineSetup&&i.origOutlineSetup.call(t.outline,n),[2,!0]}))}))},i}(Q),ie=function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e.type=4,e}return e.__extends(i,t),i.findElement=function(e,t,i){var n;if(i&&(!i.ownerId||i.ownerId===k(t())))if(i.id){if((n=t().document.getElementById(i.id))&&i.rootId){var r=V.getTabsterContext(e,n);if(!r||r.root.uid!==i.rootId)return null}}else if(i.uid){var o=v(t).elementByUId[i.uid];n=o&&o.get()}else i.observedName&&(n=e.observedElement.getElement(i.observedName));return n||null},i.getElementData=function(e,t,i,n,r){var o=Y.getDeloser(e,t),s=V.getTabsterContext(e,t),a=u(e,t),l=a&&a.observed;return{uid:C(i,t),ownerUId:r,id:t.id||void 0,rootUId:s?s.root.uid:void 0,deloserUId:o?ce(i,n,o):void 0,observedName:l&&l.name,observedDetails:l&&l.details}},i.makeResponse=function(t,n,r,o,s,a){return e.__awaiter(this,void 0,void 0,(function(){var u,l,c,d,_,f,h;return e.__generator(this,(function(e){switch(e.label){case 0:return void 0===(u=n.beginData)?l=t.focusedElement.getFocusedElement():u&&(l=i.findElement(t,r,u)||void 0),l||!u?[3,2]:(_=n.timeout,f=u.accessibility,(d=u.observedName)&&_?[4,new(x(r))((function(e,i){var n=!1,r=!1,o=!1;t.observedElement.waitElement(d,_,f).result.then((function(t){n=!0,o||!t&&!r||(o=!0,e({element:t}))})),a.then((function(t){r=!0,o||!t&&!n||(o=!0,e({crossOrigin:t}))}))}))]:[3,2]);case 1:(h=e.sent()).element?l=h.element:h.crossOrigin&&(c=h.crossOrigin),e.label=2;case 2:return[2,l?i.getElementData(t,l,r,s.ctx,o):c]}}))}))},i.shouldSelfRespond=function(){return!0},i}(Q),ne=function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e.type=5,e}return e.__extends(i,t),i.makeResponse=function(t,i,n,r,o,s){return e.__awaiter(this,void 0,void 0,(function(){var n,r,a,u,l,c;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,s];case 1:return n=e.sent(),u=(a=(r=!n&&i.beginData)&&r.deloserUId)&&o.ctx.deloserByUId[a],l=t.deloser,r&&u&&l?(c=Y.getHistory(l),[2,r.reset?c.resetFocus(u):c.focusAvailable(u)]):[2,!!n]}}))}))},i}(Q),re=function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e.type=6,e}return e.__extends(i,t),i.shouldForward=function(){return!1},i.makeResponse=function(){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){return[2,!0]}))}))},i}(Q),oe=function(){function t(e,t,i){var n=this;this._knownTargets={},this._transactions={},this._isDefaultSendUp=!1,this.isSetUp=!1,this._onMessage=function(e){if(e.data.owner!==n._ownerUId&&n._tabster){var t,i=e.data;if(i&&(t=i.transaction)&&i.type&&i.timestamp&&i.owner&&i.sentto){var r=n._knownTargets[i.owner];if(!r&&e.send&&i.owner!==n._ownerUId&&(r=n._knownTargets[i.owner]={send:e.send}),r&&(r.last=Date.now()),i.isResponse){var o=n._transactions[t];o&&o.transaction&&o.transaction.type===i.type&&o.transaction.onResponse(i)}else{var s=n._getTransactionClass(i.type),a=n.forwardTransaction(i);s&&e.send&&s.makeResponse(n._tabster,i,n._owner,n._ownerUId,n,a,!1).then((function(t){var r={transaction:i.transaction,type:i.type,isResponse:!0,timestamp:Date.now(),owner:n._ownerUId,timeout:i.timeout,sentto:{},target:"up"===i.target?"up":i.owner,endData:t};e.send(r)}))}}}},this._onPageHide=function(){n._dead()},this._onBrowserMessage=function(e){if(e.source!==n._owner())try{n._onMessage({data:JSON.parse(e.data),send:function(t){e.source&&e.source.postMessage&&e.source.postMessage(JSON.stringify(t),"*")}})}catch(e){}},this._tabster=e,this._owner=t,this._ownerUId=k(t()),this.ctx=i}return t.prototype.setup=function(e){return this.isSetUp||(this.isSetUp=!0,this.setSendUp(e),this._owner().addEventListener("pagehide",this._onPageHide),this._ping()),this._onMessage},t.prototype.setSendUp=function(e){if(!this.isSetUp)throw new Error("CrossOrigin is not set up.");this.sendUp=e||void 0;var t=this._owner();return void 0===e?this._isDefaultSendUp||t.document&&(this._isDefaultSendUp=!0,t.parent&&t.parent!==t&&t.parent.postMessage&&(this.sendUp=function(e){t.parent.postMessage(JSON.stringify(e),"*")}),t.addEventListener("message",this._onBrowserMessage)):this._isDefaultSendUp&&(t.removeEventListener("message",this._onBrowserMessage),this._isDefaultSendUp=!1),this._onMessage},t.prototype.dispose=function(){return e.__awaiter(this,void 0,void 0,(function(){var t,i,n,r;return e.__generator(this,(function(e){switch(e.label){case 0:return t=this._owner(),this._pingTimer&&(t.clearTimeout(this._pingTimer),this._pingTimer=void 0),t.removeEventListener("message",this._onBrowserMessage),t.removeEventListener("pagehide",this._onPageHide),[4,this._dead()];case 1:for(e.sent(),delete this._deadPromise,i=0,n=Object.keys(this._transactions);i<n.length;i++)(r=this._transactions[n[i]]).timer&&(t.clearTimeout(r.timer),delete r.timer),r.transaction.end();return this._knownTargets={},delete this.sendUp,[2]}}))}))},t.prototype.beginTransaction=function(e,t,i,n,r,o){var s=this;if(!this._owner)return x(this._owner).reject();var a,u=new e(this._tabster,this._owner,this._knownTargets,t,i,n,r,this.sendUp);return e.shouldSelfRespond&&e.shouldSelfRespond(this._tabster,t,this._owner,this._ownerUId)&&(a=function(t){return e.makeResponse(s._tabster,t,s._owner,s._ownerUId,s,x(s._owner).resolve(void 0),!0)}),this._beginTransaction(u,i,a,o)},t.prototype.removeTarget=function(e){delete this._knownTargets[e]},t.prototype._beginTransaction=function(e,t,i,n){var r=this,o=this._owner(),s={transaction:e,timer:o.setTimeout((function(){delete s.timer,e.end("Cross origin transaction timed out.")}),1500+(t||0))};this._transactions[e.id]=s;var a=e.begin(i);return a.catch((function(){})).finally((function(){s.timer&&o.clearTimeout(s.timer),delete r._transactions[e.id]})),a.then((function(e){return e}),n?void 0:function(){})},t.prototype.forwardTransaction=function(e){var t=this._owner,i=e.target;if(i===this._ownerUId)return x(t).resolve();var n=this._getTransactionClass(e.type);if(n){if(void 0===n.shouldForward||n.shouldForward(this._tabster,e,t,this._ownerUId)){var r=e.sentto;return"up"===i&&(i=void 0,r[this._ownerUId]=!0),delete r.up,this._beginTransaction(new n(this._tabster,t,this._knownTargets,e.beginData,e.timeout,r,i,this.sendUp),e.timeout)}return x(t).resolve()}return x(t).reject("Unknown transaction type "+e.type)},t.prototype._getTransactionClass=function(e){switch(e){case 1:return Z;case 2:return ee;case 3:return te;case 4:return ie;case 5:return ne;case 6:return re;default:return null}},t.prototype._dead=function(){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return this._deadPromise||this.ctx.focusOwner!==this._ownerUId||(this._deadPromise=this.beginTransaction(te,{ownerUId:this._ownerUId,state:4})),this._deadPromise?[4,this._deadPromise]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}}))}))},t.prototype._ping=function(){return e.__awaiter(this,void 0,void 0,(function(){var t,i,n,r,o=this;return e.__generator(this,(function(e){switch(e.label){case 0:return this._pingTimer?[2]:(i=Date.now(),n=Object.keys(this._knownTargets).filter((function(e){return i-(o._knownTargets[e].last||0)>3e3})),this.sendUp&&n.push("up"),n.length?[4,x(this._owner).all(n.map((function(e){return o.beginTransaction(re,void 0,void 0,void 0,e,!0).then((function(){return!0}),(function(){return"up"!==e&&(t||(t={}),t[e]=!0,delete o._knownTargets[e]),!1}))})))]:[3,2]);case 1:e.sent(),e.label=2;case 2:return t?[4,this.beginTransaction(ie,void 0)]:[3,5];case 3:return!e.sent()&&this.ctx.focusOwner&&this.ctx.focusOwner in t?[4,this.beginTransaction(te,{ownerUId:this._ownerUId,state:2,force:!0})]:[3,5];case 4:e.sent(),(r=this._tabster.deloser)&&Y.forceRestoreFocus(r),e.label=5;case 5:return this._pingTimer=this._owner().setTimeout((function(){o._pingTimer=void 0,o._ping()}),3e3),[2]}}))}))},t}(),se=function(){function e(e,t,i,n,r,o,s){this._tabster=e,this.uid=t,this.ownerId=i,this.id=n,this.rootId=r,this.observedName=o,this.observedDetails=s}return e.prototype.focus=function(e,t){return this._tabster.crossOrigin.focusedElement.focus(this,e,t)},e}(),ae=function(t){function i(e){var i=t.call(this)||this;return i._transactions=e,i}return e.__extends(i,t),i.prototype.dispose=function(){t.prototype.dispose.call(this)},i.dispose=function(e){e.dispose()},i.prototype.focus=function(t,i,n){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){return[2,this._focus({uid:t.uid,id:t.id,rootId:t.rootId,ownerId:t.ownerId,observedName:t.observedName},i,n)]}))}))},i.prototype.focusById=function(t,i,n,r){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){return[2,this._focus({id:t,rootId:i},n,r)]}))}))},i.prototype.focusByObservedName=function(t,i,n,r,o){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){return[2,this._focus({observedName:t,rootId:n},r,o,i)]}))}))},i.prototype._focus=function(t,i,n,r){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(o){return[2,this._transactions.beginTransaction(ee,e.__assign(e.__assign({},t),{noFocusedProgrammaticallyFlag:i,noAccessibleCheck:n}),r).then((function(e){return!!e}))]}))}))},i.setVal=function(e,t,i){e.setVal(t,i)},i}(d),ue=function(t){function n(e,i){var n=t.call(this)||this;return n._lastRequestFocusId=0,n._tabster=e,n._transactions=i,n}return e.__extends(n,t),n.prototype.dispose=function(){t.prototype.dispose.call(this)},n.dispose=function(e){e.dispose()},n.prototype.getElement=function(t,i){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){return[2,this.waitElement(t,0,i)]}))}))},n.prototype.waitElement=function(t,i,n){return e.__awaiter(this,void 0,void 0,(function(){var r=this;return e.__generator(this,(function(e){return[2,this._transactions.beginTransaction(ie,{observedName:t,accessibility:n},i).then((function(e){return e?te.createElement(r._tabster,e):null}))]}))}))},n.prototype.requestFocus=function(t,n){return e.__awaiter(this,void 0,void 0,(function(){var r,o=this;return e.__generator(this,(function(e){return r=++this._lastRequestFocusId,[2,this.waitElement(t,n,i.Focusable).then((function(e){return!(o._lastRequestFocusId!==r||!e)&&o._tabster.crossOrigin.focusedElement.focus(e,!0)}))]}))}))},n.trigger=function(e,t,i){e.trigger(t,i)},n}(d),le=function(){function t(t){var i=this;this._init=function(){i._initTimer=void 0;var e=i._tabster;e.keyboardNavigation.subscribe(i._onKeyboardNavigationStateChanged),e.focusedElement.subscribe(i._onFocus),e.observedElement.subscribe(i._onObserved),i._ctx.origOutlineSetup||(i._ctx.origOutlineSetup=e.outline.setup,e.outline.setup=i._outlineSetup),i._transactions.beginTransaction(Z,void 0,void 0,void 0,"up").then((function(e){e&&i._tabster.keyboardNavigation.isNavigatingWithKeyboard()!==e.isNavigatingWithKeyboard&&(i._ctx.ignoreKeyboardNavigationStateUpdate=!0,_.setVal(i._tabster.keyboardNavigation,e.isNavigatingWithKeyboard),i._ctx.ignoreKeyboardNavigationStateUpdate=!1)}))},this._onKeyboardNavigationStateChanged=function(e){i._ctx.ignoreKeyboardNavigationStateUpdate||i._transactions.beginTransaction(te,{state:5,ownerUId:k(i._win()),isNavigatingWithKeyboard:e})},this._onFocus=function(t,n){var r=i._win(),o=k(r);i._blurTimer&&(r.clearTimeout(i._blurTimer),i._blurTimer=void 0),t?i._transactions.beginTransaction(te,e.__assign(e.__assign({},ie.getElementData(i._tabster,t,i._win,i._ctx,o)),{state:1})):i._blurTimer=r.setTimeout((function(){i._blurTimer=void 0,i._ctx.focusOwner&&i._ctx.focusOwner===o&&i._transactions.beginTransaction(ie,void 0).then((function(e){e||i._ctx.focusOwner!==o||i._transactions.beginTransaction(te,{ownerUId:o,state:2,force:!1})}))}),0)},this._onObserved=function(e,t){var n=ie.getElementData(i._tabster,e,i._win,i._ctx,k(i._win()));n.state=3,n.observedName=t.name,n.observedDetails=t.details,i._transactions.beginTransaction(te,n)},this._outlineSetup=function(e){i._transactions.beginTransaction(te,{state:6,ownerUId:k(i._win()),outline:e})},this._tabster=t,this._win=t.getWindow,this._ctx={ignoreKeyboardNavigationStateUpdate:!1,deloserByUId:{}},this._transactions=new oe(t,this._win,this._ctx),this.focusedElement=new ae(this._transactions),this.observedElement=new ue(t,this._transactions)}return t.prototype.setup=function(e){return this.isSetUp()?this._transactions.setSendUp(e):(this._initTimer=this._win().setTimeout(this._init,0),this._transactions.setup(e))},t.prototype.isSetUp=function(){return this._transactions.isSetUp},t.prototype.dispose=function(){var e;this._initTimer&&(this._win().clearTimeout(this._initTimer),this._initTimer=void 0);var t=this._tabster;t.keyboardNavigation.unsubscribe(this._onKeyboardNavigationStateChanged),t.focusedElement.unsubscribe(this._onFocus),null===(e=t.observedElement)||void 0===e||e.unsubscribe(this._onObserved),this._transactions.dispose(),ae.dispose(this.focusedElement),ue.dispose(this.observedElement),this._ctx.deloserByUId={}},t.dispose=function(e){e.dispose()},t}();function ce(e,t,i){var n=i.getElement();if(n){var r=C(e,n);return t.deloserByUId[r]||(t.deloserByUId[r]=i),r}}var de,_e,fe=["a[href]","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])","*[tabindex]","*[contenteditable]"].join(", "),he=function(){function t(e,t){this._tabster=e,this._win=t}return t.prototype.dispose=function(){},t.dispose=function(e){e.dispose()},t.prototype._getBody=function(){var e=this._tabster.focusedElement.getLastFocusedElement();return e&&e.ownerDocument?e.ownerDocument.body:this._win().document.body},t.prototype.getProps=function(e){var t=u(this._tabster,e);return t&&t.focusable||{}},t.prototype.isFocusable=function(e,t,i,n){return!(!N(e,fe)||!t&&-1===e.tabIndex)&&(i||this.isVisible(e))&&(n||this.isAccessible(e))},t.prototype.isVisible=function(e){if(!e.ownerDocument)return!1;if(null===e.offsetParent&&e.ownerDocument.body!==e)return!1;var t=e.ownerDocument.defaultView;if(!t)return!1;var i=e.ownerDocument.body.getBoundingClientRect();return(0!==i.width||0!==i.height)&&"hidden"!==t.getComputedStyle(e).visibility},t.prototype.isAccessible=function(e){for(var t,i=e;i;i=i.parentElement){var n=u(this._tabster,i);if(this._isHidden(i))return!1;if(!(null===(t=null==n?void 0:n.focusable)||void 0===t?void 0:t.ignoreAriaDisabled)&&this._isDisabled(i))return!1}return!0},t.prototype._isDisabled=function(e){return e.hasAttribute("disabled")},t.prototype._isHidden=function(e){var t=e.getAttribute("aria-hidden");return!(!t||"true"!==t.toLowerCase())},t.prototype.findFirst=function(t){return this.findElement(e.__assign({container:this._getBody()},t))},t.prototype.findLast=function(t){return this.findElement(e.__assign({container:this._getBody(),prev:!0},t))},t.prototype.findNext=function(t){return this.findElement(e.__assign({container:this._getBody()},t))},t.prototype.findPrev=function(t){return this.findElement(e.__assign({container:this._getBody(),prev:!0},t))},t.prototype.findDefault=function(t){var i=this;return this.findElement(e.__assign(e.__assign({},t),{acceptCondition:function(e){return i._tabster.focusable.isFocusable(e,t.includeProgrammaticallyFocusable)&&!!i.getProps(e).isDefault}}))||null},t.prototype.findAll=function(e){var t=this,i=e.container,n=e.acceptCondition,r=e.includeProgrammaticallyFocusable,o=e.skipDefaultCheck,s={container:i,from:null,isForward:!0,acceptCondition:function(e){var i,s=!1;return(i=!!o||t._tabster.focusable.isFocusable(e,r))&&(s=!n||n(e)),i&&s},includeProgrammaticallyFocusable:r,ignoreGroupper:e.ignoreGroupper,ignoreUncontrolled:e.ignoreUncontrolled,ignoreAccessibiliy:e.ignoreAccessibiliy,grouppers:{}},a=g(i.ownerDocument,i,(function(e){return t._acceptElement(e,s)}));if(!a||!(null==a?void 0:a.filter))return[];for(var u,l=[];u=a.nextNode();)l.push(u);return l},t.prototype.findElement=function(e){var t=this,i=e.container,n=e.currentElement,r=void 0===n?null:n,o=e.includeProgrammaticallyFocusable,s=e.ignoreGroupper,a=e.ignoreUncontrolled,u=e.ignoreAccessibiliy,l=e.prev,c=e.onUncontrolled,d=e.acceptCondition;if(!i)return null;if(!i.ownerDocument||r&&i!==r&&!i.contains(r))return null;d||(d=function(e){return t._tabster.focusable.isFocusable(e,o,u,u)});var _={container:i,from:r,isForward:!l,acceptCondition:d,includeProgrammaticallyFocusable:o,ignoreGroupper:s,ignoreUncontrolled:a,ignoreAccessibiliy:u,grouppers:{}},f=g(i.ownerDocument,i,(function(e){return t._acceptElement(e,_)}));if(!f)return null;if(r)f.currentNode=r;else if(l){var h=z(i);if(!h)return null;if(this._acceptElement(h,_)===NodeFilter.FILTER_ACCEPT)return h;f.currentNode=h}var v=l?f.previousNode():f.nextNode(),p=_.nextUncontrolled;return p&&(v=v?void 0:null,c&&c(p)),_.found?_.foundElement:v},t.prototype._acceptElement=function(e,t){if(e===t.container)return NodeFilter.FILTER_SKIP;if(t.found)return NodeFilter.FILTER_ACCEPT;var i=V.getTabsterContext(this._tabster,e);if(!i)return NodeFilter.FILTER_SKIP;if(t.ignoreUncontrolled){if(D(e))return NodeFilter.FILTER_SKIP}else if(i.groupper)t.nextGroupper=i.groupper.getElement();else if(i.mover)t.nextMover=i.mover.getElement();else if(i.uncontrolled&&!t.nextUncontrolled&&!i.groupper&&!i.mover)return t.nextUncontrolled=i.uncontrolled,NodeFilter.FILTER_REJECT;if("IFRAME"===e.tagName)return NodeFilter.FILTER_ACCEPT;if(!t.ignoreAccessibiliy&&!this.isAccessible(e))return NodeFilter.FILTER_REJECT;if(!t.ignoreGroupper){var n=void 0,r=void 0;r=i.mover;var o,s=i.isGroupperFirst;if((n=i.groupper)&&s?r=void 0:r&&!s&&(n=void 0),n&&void 0!==(o=n.acceptElement(e,t)))return o;if(r&&void 0!==(o=r.acceptElement(e,t)))return o}return t.acceptCondition(e)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP},t}(),ve=function(i){function n(e,r){var o=i.call(this)||this;return o._init=function(){o._initTimer=void 0;var e=o._win();e.document.addEventListener(t.KEYBORG_FOCUSIN,o._onFocusIn,!0),e.document.addEventListener("focusout",o._onFocusOut,!0),o._tabster.controlTab&&e.addEventListener("keydown",o._onKeyDown,!0)},o._onFocusIn=function(e){o._setFocusedElement(e.target,e.details.relatedTarget||void 0,e.details.isFocusedProgrammatically)},o._onFocusOut=function(e){o._setFocusedElement(void 0,e.relatedTarget||void 0)},o._validateFocusedElement=function(e){},o._onKeyDown=function(e){var i;if(9===e.keyCode){var r=o.getVal();if(r&&r.ownerDocument&&"true"!==r.contentEditable){var s=V.getTabsterContext(o._tabster,r,{checkRtl:!0});if(s){var a=e.shiftKey,u=n.findNextTabbable(o._tabster,s,r,a);if(u){var l=u.uncontrolled;if(l)s.uncontrolled||o._moveToUncontrolled(l,a);else{var c=u.element;if(s.modalizer){var d=c&&V.getTabsterContext(o._tabster,c);if((!d||s.root.uid!==d.root.uid||!(null===(i=d.modalizer)||void 0===i?void 0:i.isActive()))&&s.modalizer.onBeforeFocusOut())return void e.preventDefault()}c?"IFRAME"!==c.tagName&&(e.preventDefault(),t.nativeFocus(c)):s.root.moveOutWithDefaultAction(a)}}}}}},o._tabster=e,o._win=r,o._initTimer=r().setTimeout(o._init,0),o}return e.__extends(n,i),n.prototype.dispose=function(){i.prototype.dispose.call(this);var e=this._win();this._initTimer&&(e.clearTimeout(this._initTimer),this._initTimer=void 0),e.document.removeEventListener(t.KEYBORG_FOCUSIN,this._onFocusIn,!0),e.document.removeEventListener("focusout",this._onFocusOut,!0),this._tabster.controlTab&&e.addEventListener("keydown",this._onKeyDown,!0),delete n._lastResetElement,delete this._nextVal,delete this._lastVal},n.dispose=function(e){e.dispose()},n.forgetMemorized=function(e,t){var i,r,o=n._lastResetElement,s=o&&o.get();s&&t.contains(s)&&delete n._lastResetElement,(s=null===(r=null===(i=e._nextVal)||void 0===i?void 0:i.element)||void 0===r?void 0:r.get())&&t.contains(s)&&delete e._nextVal,(s=(o=e._lastVal)&&o.get())&&t.contains(s)&&delete e._lastVal},n.prototype.getFocusedElement=function(){return this.getVal()},n.prototype.getLastFocusedElement=function(){var e,t=null===(e=this._lastVal)||void 0===e?void 0:e.get();return(!t||t&&!R(t.ownerDocument,t))&&(this._lastVal=t=void 0),t},n.prototype.focus=function(e,t,i){return!!this._tabster.focusable.isFocusable(e,t,!1,i)&&(e.focus(),!0)},n.prototype.focusDefault=function(e){var t=this._tabster.focusable.findDefault({container:e});return!!t&&(this._tabster.focusedElement.focus(t),!0)},n.prototype.focusFirst=function(t){var i,r=t.container;if(r){var o=V.getTabsterContext(this._tabster,r,{checkRtl:!0});if(o){var s=n.findNextTabbable(this._tabster,o,r);s&&!s.uncontrolled&&(i=s.element)}}return i||(i=this._tabster.focusable.findFirst(t))||(i=this._tabster.focusable.findFirst(e.__assign(e.__assign({},t),{ignoreUncontrolled:!0,ignoreAccessibiliy:!0}))),!!i&&(this.focus(i,!1,!0),!0)},n.prototype.focusLast=function(t){var i,r=t.container;if(r){var o=V.getTabsterContext(this._tabster,r,{checkRtl:!0});if(o){var s=n.findNextTabbable(this._tabster,o,z(r),!0);s&&!s.uncontrolled&&(i=s.element)}}return i||(i=this._tabster.focusable.findLast(t))||(i=this._tabster.focusable.findLast(e.__assign(e.__assign({},t),{ignoreUncontrolled:!0,ignoreAccessibiliy:!0}))),!!i&&(this.focus(i,!1,!0),!0)},n.prototype.resetFocus=function(e){if(!this._tabster.focusable.isVisible(e))return!1;if(this._tabster.focusable.isFocusable(e,!0,!0,!0))this.focus(e);else{var t=e.getAttribute("tabindex"),i=e.getAttribute("aria-hidden");e.tabIndex=-1,e.setAttribute("aria-hidden","true"),n._lastResetElement=new m(this._win,e),this.focus(e,!0,!0),this._setOrRemoveAttribute(e,"tabindex",t),this._setOrRemoveAttribute(e,"aria-hidden",i)}return!0},n.prototype._setOrRemoveAttribute=function(e,t,i){null===i?e.removeAttribute(t):e.setAttribute(t,i)},n.prototype._setFocusedElement=function(e,t,i){var r;if(!this._tabster._noop){var o={relatedTarget:t};if(e){var s=null===(r=n._lastResetElement)||void 0===r?void 0:r.get();if(n._lastResetElement=void 0,s===e||D(e))return;o.isFocusedProgrammatically=i}var a=this._nextVal={element:e?new m(this._win,e):void 0,details:o};e&&e!==this._val&&this._validateFocusedElement(e),this._nextVal===a&&this.setVal(e,o),this._nextVal=void 0}},n.prototype.setVal=function(e,t){i.prototype.setVal.call(this,e,t),e&&(this._lastVal=new m(this._win,e))},n.findNextTabbable=function(e,t,i,n){var r,o=null;if(i)r=i;else{var s=t.root.getElement();if(!s)return null;r=z(s)||s}if(t.groupper&&t.mover)t.isGroupperFirst?null===(o=t.groupper.findNextTabbable(r,n))&&(o=t.mover.findNextTabbable(r,n)):null===(o=t.mover.findNextTabbable(r,n))&&(o=t.groupper.findNextTabbable(r,n));else if(t.groupper)o=t.groupper.findNextTabbable(r,n);else if(t.mover)o=t.mover.findNextTabbable(r,n);else{var a,u=function(e){a=e};o={element:n?e.focusable.findPrev({currentElement:r,onUncontrolled:u}):e.focusable.findNext({currentElement:r,onUncontrolled:u}),uncontrolled:a}}return o},n.prototype._moveToUncontrolled=function(e,i){var n=new U(this._win,{isPhantom:!0,isFirst:!0}).input;if(n){var r=e.parentElement;r&&(r.insertBefore(n,i?e.nextElementSibling:e),t.nativeFocus(n))}},n}(d),pe=function(t){function i(e,i){var n=t.call(this,i,e)||this;return n._onFocusDummyInput=function(e){var t=n._element.get();t&&!e.shouldMoveOut&&(e.isFirst?n._tabster.focusedElement.focusFirst({container:t}):n._tabster.focusedElement.focusLast({container:t}))},n._tabster=i,n.firstDummy.onFocusIn=n._onFocusDummyInput,n.lastDummy.onFocusIn=n._onFocusDummyInput,n}return e.__extends(i,t),i}(P),me=function(t){function i(e,i,n){var r=t.call(this,e,i,n)||this;return r._shouldTabInside=!1,r.makeTabbable(!1),e.controlTab||(r._dummyManager=new pe(r._element,e)),r}return e.__extends(i,t),i.prototype.dispose=function(){var e;this._element.get(),null===(e=this._dummyManager)||void 0===e||e.dispose(),delete this._first},i.prototype.findNextTabbable=function(e,t){var i=this.getElement();if(!i||!i.contains(e))return null;var n,r=this._tabster,o=null,a=function(e){n=e};if(this._shouldTabInside){var u=this.getFirst();if(u){var l,c=t?u:z(u);(l=c?(t?r.focusable.findPrev({container:i,currentElement:c,ignoreUncontrolled:!0}):r.focusable.findNext({container:i,currentElement:c,ignoreUncontrolled:!0}))?i:u:i)&&(o=t?r.focusable.findPrev({container:l,currentElement:e,onUncontrolled:a}):r.focusable.findNext({container:l,currentElement:e,onUncontrolled:a}),n||o||this._props.tabbability!==s.LimitedTrapFocus||(o=t?r.focusable.findLast({container:l}):r.focusable.findFirst({container:l})))}}if(null===o){var d=i.parentElement;if(d){var _=V.getTabsterContext(r,d);if(_)return ve.findNextTabbable(r,_,e,t)}}return{element:o,uncontrolled:n}},i.prototype.makeTabbable=function(e){this._shouldTabInside=e},i.prototype.shouldTabInside=function(){return this._shouldTabInside},i.prototype.isActive=function(){for(var e,t=this.getElement()||null,i=!0,n=null==t?void 0:t.parentElement;n;n=n.parentElement){var r=null===(e=u(this._tabster,n))||void 0===e?void 0:e.groupper;r&&(r._shouldTabInside||(i=!1))}return i?!!this._props.tabbability&&this._shouldTabInside:void 0},i.prototype.getFirst=function(){var e,t,i=this.getElement();return i&&((t=null===(e=this._first)||void 0===e?void 0:e.get())||(t=(this._tabster.focusable.isFocusable(i)?i:this._tabster.focusable.findFirst({container:i,ignoreUncontrolled:!0}))||void 0)),t},i.prototype.setFirst=function(e){e?this._first=new m(this._tabster.getWindow,e):delete this._first},i.prototype.acceptElement=function(e,t){var i=t.grouppers,n=t.container,r=i[this.id];if(!r){var o=this.isActive(),s=this.getElement();if(s){var a=s!==n&&n.contains(s);if(r=i[this.id]={isInside:a,isActive:o},a&&!0!==o){var u=this.getFirst();if(u&&t.acceptCondition(u)){var l=this._tabster.focusedElement.getFocusedElement();r.first=u,l&&this.setFirst(s.contains(l)?void 0:u)}}}}if(r.isInside){if(void 0===r.isActive)return NodeFilter.FILTER_REJECT;if(!1===r.isActive)return r.first===e?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}},i}(M),be=function(){function e(e,i){var n=this;this._current={},this._init=function(){n._initTimer=void 0;var e=n._win();n._tabster.focusedElement.subscribe(n._onFocus),e.document.addEventListener("mousedown",n._onMouseDown,!0),e.addEventListener("keydown",n._onKeyDown,!0)},this._onFocus=function(e){e&&n._updateCurrent(e,!1,!0)},this._onMouseDown=function(e){e.target&&n._updateCurrent(e.target,!0)},this._onKeyDown=function(e){var i,r,o;if(13===e.keyCode||27===e.keyCode||9===e.keyCode){var s=e.shiftKey,a=n._tabster.focusedElement.getFocusedElement();if(a){var l=V.getTabsterContext(n._tabster,a),c=null==l?void 0:l.groupper;if(l&&c){var d=void 0;if(13===e.keyCode){var _=c.getFirst();if(_!==a||c.isActive())return;(d=n._tabster.focusable.findFirst({container:_,ignoreGroupper:!0}))&&n._updateCurrent(d)}else if(27===e.keyCode)for(var f=a;f;f=f.parentElement){var h=null===(i=u(n._tabster,f))||void 0===i?void 0:i.groupper;if(h&&(h.isActive()||!h.getProps().tabbability)&&(h.makeTabbable(!1),d=h.getFirst()))break}else 9!==e.keyCode||n._tabster.controlTab||(d=null===(r=ve.findNextTabbable(n._tabster,l,a,s))||void 0===r?void 0:r.element);d?(e.preventDefault(),t.nativeFocus(d)):null===(o=c._dummyManager)||void 0===o||o.moveOutWithDefaultAction(s)}}}},this._tabster=e,this._win=i,this._initTimer=i().setTimeout(this._init,0)}return e.prototype.dispose=function(){var e=this._win();this._current={},this._initTimer&&(e.clearTimeout(this._initTimer),this._initTimer=void 0),this._tabster.focusedElement.unsubscribe(this._onFocus),e.document.removeEventListener("mousedown",this._onMouseDown,!0),e.removeEventListener("keydown",this._onKeyDown,!0)},e.dispose=function(e){e.dispose()},e.prototype.forgetCurrentGrouppers=function(){this._current={}},e.prototype._updateCurrent=function(e,t,i){for(var n,r={},o=!0,s=e;s;s=s.parentElement)(c=null===(n=u(this._tabster,s))||void 0===n?void 0:n.groupper)&&(r[c.id]=!0,!o||!i||c.shouldTabInside()||c.getProps().tabbability&&(s===e||!this._tabster.focusable.isFocusable(s)&&e===c.getFirst())||(o=!1),!t&&o||(this._current[c.id]=c,c.makeTabbable(!0)),o=!1);for(var a=0,l=Object.keys(this._current);a<l.length;a++){var c,d=l[a];(c=this._current[d]).id in r||(c.makeTabbable(!1),c.setFirst(void 0),delete this._current[d])}},e.createGroupper=function(e,t,i){return new me(e,t,i)},e}(),ge=0,ye=function(i){function n(e,n,r,o,s,a){var u=i.call(this,e,n,a)||this;u._isFocused=!1,u._onKeyDown=function(e){var i=e.shiftKey;if(9===e.keyCode){var n,r=u._tabster.focusedElement.getFocusedElement(),o=u.getElement(),s=i?"findPrev":"findNext";r&&(null==o?void 0:o.contains(r))&&(n=u._tabster.focusable[s]({container:u.getElement(),currentElement:r})),n?(e.preventDefault(),t.nativeFocus(n)):u._props.isOthersAccessible||u._moveOutWithDefault(i)}},u.internalId="ml"+ ++ge,u.userId=a.id,u._onDispose=r,u._moveOutWithDefault=o,u._onActiveChange=s,n.addEventListener("keydown",u._onKeyDown);var l=n.parentElement;return u._modalizerParent=l?new m(e.getWindow,l):null,u._setAccessibilityProps(),u}return e.__extends(n,i),n.prototype.setProps=function(t){t.id&&(this.userId=t.id),this._props=e.__assign({},t),this._setAccessibilityProps()},n.prototype.dispose=function(){this._onDispose(this),this._remove()},n.prototype.setActive=function(e){var t,i,n,r=this;if(e!==this._isActive){this._isActive=e,this._onActiveChange(e);var o=(null===(t=this._element.get())||void 0===t?void 0:t.ownerDocument)||(null===(n=null===(i=this._modalizerParent)||void 0===i?void 0:i.get())||void 0===n?void 0:n.ownerDocument);o||(o=this._tabster.getWindow().document);var s=g(o,o.body,(function(t){var i;if(r._props.isOthersAccessible)return NodeFilter.FILTER_REJECT;var n=r._element.get(),o=null===(i=r._modalizerParent)||void 0===i?void 0:i.get(),s=n===t,a=!!t.contains(n||null),u=!!t.contains(o||null);if(s)return NodeFilter.FILTER_REJECT;if(a||u)return NodeFilter.FILTER_SKIP;!function(e,t,i,n){var r=e.storageEntry(t,!0);if(!r.aug){if(void 0===n)return;r.aug={}}if(void 0===n){if(i in r.aug){var o=r.aug[i];delete r.aug[i],null===o?t.removeAttribute(i):t.setAttribute(i,o)}}else i in r.aug||(r.aug[i]=t.getAttribute(i)),null===n?t.removeAttribute(i):t.setAttribute(i,n);void 0===n&&0===Object.keys(r.aug).length&&(delete r.aug,e.storageEntry(t,!1))}(r._tabster,t,"aria-hidden",e?"true":void 0);var l=n!==(null==n?void 0:n.ownerDocument.body)&&(null==n?void 0:n.ownerDocument.body.contains(n));return o!==(null==o?void 0:o.ownerDocument.body)&&(null==o?void 0:o.ownerDocument.body.contains(o))||l?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_SKIP}));if(s)for(;s.nextNode(););}},n.prototype.isActive=function(){return!!this._isActive},n.prototype.contains=function(e){var t;return!!(null===(t=this.getElement())||void 0===t?void 0:t.contains(e))},n.prototype.onBeforeFocusOut=function(){var e=this.getElement();return!!e&&!S(e,"tabster:modalizer",{eventName:"beforefocusout"})},n.prototype._remove=function(){},n.prototype._setAccessibilityProps=function(){},n}(M),we=function(t){function i(e,i,n){var r=t.call(this,i,n)||this;return r._onFocusDummyInput=function(e){var t=r._modalizerAPI.activeModalizer;if(t&&!e.shouldMoveOut){var i=r._tabster.focusable[e.isFirst?"findFirst":"findLast"]({container:t.getElement()});i&&r._tabster.focusedElement.focus(i)}},r.setTabbable=function(e){var t=e?0:-1;r.firstDummy.input&&(r.firstDummy.input.tabIndex=t),r.lastDummy.input&&(r.lastDummy.input.tabIndex=t)},r._modalizerAPI=e,r._tabster=i,r.firstDummy.onFocusIn=r._onFocusDummyInput,r.lastDummy.onFocusIn=r._onFocusDummyInput,r.setTabbable(!1),r}return e.__extends(i,t),i}(P),Te=function(){function e(e){var t=this;this._init=function(){t._initTimer=void 0,t._tabster.focusedElement.subscribe(t._onFocus)},this._onModalizerDispose=function(e){e.setActive(!1),t.activeModalizer===e&&(t.activeModalizer=void 0),delete t._modalizers[e.userId]},this._onFocus=function(e,i){var n,r,o,s=e&&V.getTabsterContext(t._tabster,e);if(s&&e){t._focusOutTimer&&(t._win().clearTimeout(t._focusOutTimer),t._focusOutTimer=void 0);var a=null==s?void 0:s.modalizer;if(a!==t.activeModalizer)if(i.isFocusedProgrammatically&&!(null===(n=t.activeModalizer)||void 0===n?void 0:n.contains(e)))null===(r=t.activeModalizer)||void 0===r||r.setActive(!1),t.activeModalizer=void 0,a&&(t.activeModalizer=a,t.activeModalizer.setActive(!0));else if(!(null===(o=t.activeModalizer)||void 0===o?void 0:o.getProps().isOthersAccessible)){var u=t._win();u.clearTimeout(t._restoreModalizerFocusTimer),t._restoreModalizerFocusTimer=u.setTimeout((function(){return t._restoreModalizerFocus(e)}),100)}}},this._tabster=e,this._win=e.getWindow,this._initTimer=this._win().setTimeout(this._init,0),this._modalizers={};var i=this._win().document.body;e.controlTab||(this._dummyManager=new we(this,e,new m(this._win,i)))}return e.prototype.dispose=function(){var e,t=this,i=this._win();null===(e=this._dummyManager)||void 0===e||e.dispose(),this._initTimer&&(i.clearTimeout(this._initTimer),this._initTimer=void 0),i.clearTimeout(this._restoreModalizerFocusTimer),i.clearTimeout(this._focusOutTimer),Object.keys(this._modalizers).forEach((function(e){t._modalizers[e]&&(t._modalizers[e].dispose(),delete t._modalizers[e])})),this._tabster.focusedElement.unsubscribe(this._onFocus),delete this.activeModalizer},e.dispose=function(e){e.dispose()},e.prototype.focus=function(e,t,i){var n=V.getTabsterContext(this._tabster,e);if(n&&n.modalizer){this.activeModalizer=n.modalizer,this.activeModalizer.setActive(!0);var r=this.activeModalizer.getProps(),o=this.activeModalizer.getElement();if(o){if(void 0===t&&(t=r.isNoFocusFirst),!t&&this._tabster.keyboardNavigation.isNavigatingWithKeyboard()&&this._tabster.focusedElement.focusFirst({container:o}))return!0;if(void 0===i&&(i=r.isNoFocusDefault),!i&&this._tabster.focusedElement.focusDefault(o))return!0;this._tabster.focusedElement.resetFocus(o)}}return!1},e.updateModalizer=function(e,t,i){if(i&&e.modalizer){var n=e.modalizer;t.isActive()&&t.setActive(!1),delete n._modalizers[t.userId],n.activeModalizer===t&&(n.activeModalizer=void 0)}},e.prototype._restoreModalizerFocus=function(e){if((null==e?void 0:e.ownerDocument)&&this.activeModalizer){var t=this._tabster.focusable.findFirst({container:this.activeModalizer.getElement()});if(t){if(e.compareDocumentPosition(t)&document.DOCUMENT_POSITION_PRECEDING&&!(t=this._tabster.focusable.findLast({container:e.ownerDocument.body})))throw new Error("Something went wrong.");this._tabster.focusedElement.focus(t)}else e.blur()}},e.createModalizer=function(e,t,i){var n,r,o,s,a,u=e.modalizer,l=new ye(e,t,u._onModalizerDispose,null!==(r=null===(n=u._dummyManager)||void 0===n?void 0:n.moveOutWithDefaultAction)&&void 0!==r?r:function(){return null},null!==(s=null===(o=u._dummyManager)||void 0===o?void 0:o.setTabbable)&&void 0!==s?s:function(){return null},i);if(u._modalizers[i.id]=l,t.contains(null!==(a=e.focusedElement.getFocusedElement())&&void 0!==a?a:null)){var c=u.activeModalizer;c&&c.setActive(!1),u.activeModalizer=l,u.activeModalizer.setActive(!0)}return l},e}(),Ee=["input","textarea","*[contenteditable]"].join(", "),Fe=function(i){function n(e,n,r){var o=i.call(this,n,e)||this;return o._onFocusDummyInput=function(e){var i,n=o._element.get();if(n&&!e.shouldMoveOut){var r=e.isFirst?o._tabster.focusable.findFirst({container:n}):o._tabster.focusable.findLast({container:n}),s=null===(i=o._getMemorized())||void 0===i?void 0:i.get();s&&(r=s),r&&t.nativeFocus(r)}},o._tabster=n,o._getMemorized=r,o.firstDummy.onFocusIn=o._onFocusDummyInput,o.lastDummy.onFocusIn=o._onFocusDummyInput,o}return e.__extends(n,i),n}(P),De=function(t){function i(e,i,n,r){var o=t.call(this,e,i,r)||this;return o._visible={},o._prevVisible={},o._hasFullyVisible=!1,o._focusables={},o._domChanged=function(){var e;o._domChangedTimer=void 0;var t=o.getElement();if(t){for(var i=o._tabster.focusable.findAll({container:t}),n={},r=o._focusables,s=0;s<i.length;s++){var a=i[s],u=r[d=C(o._win,a)];u||(u=new m(o._win,a)),n[d]=u}for(var l=0,c=Object.keys(r);l<c.length;l++){var d;if(!((d=c[l])in n)){var _=r[d].get();delete r[d],delete o._visible[d],_&&(null===(e=o._current)||void 0===e?void 0:e.get())===_&&o.setCurrent(void 0)}}o._focusables=n,o.updateVisible(!0)}},o._win=e.getWindow,(o._props.trackState||o._props.visibilityAware)&&(o._observeState(),o._domChangedTimer=e.getWindow().setTimeout(o._domChanged,0)),o._onDispose=n,e.controlTab||(o._dummyManagner=new Fe(o._element,e,(function(){return r.memorizeCurrent?o._current:void 0}))),o}return e.__extends(i,t),i.prototype.dispose=function(){var e;this._onDispose(this),this._focusables={},this._unobserve&&(this._unobserve(),this._unobserve=void 0);var t=this._win();this._updateVisibleTimer&&(t.clearTimeout(this._updateVisibleTimer),this._updateVisibleTimer=void 0),this._domChangedTimer&&(t.clearTimeout(this._domChangedTimer),this._domChangedTimer=void 0),this._onChangeTimer&&(t.clearTimeout(this._onChangeTimer),this._onChangeTimer=void 0),null===(e=this._dummyManagner)||void 0===e||e.dispose()},i.prototype.setCurrent=function(e){return this._current=e?new m(this._win,e):void 0,(this._props.trackState||this._props.visibilityAware)&&this._processOnChange(),!1},i.prototype.getCurrent=function(){var e;return(null===(e=this._current)||void 0===e?void 0:e.get())||null},i.prototype.findNextTabbable=function(e,t){var i=this.getElement();if(!i||!i.contains(e))return null;var n,r=this._tabster,o=r.focusable,s=null,a=function(e){n=e};if(this._props.tabbable&&(s=t?o.findPrev({currentElement:e,container:i,onUncontrolled:a}):o.findNext({currentElement:e,container:i,onUncontrolled:a})),null===s){var u=i.parentElement;if(u){var l=V.getTabsterContext(r,u);if(l){var c=(t?i:o.findLast({container:i}))||i;return ve.findNextTabbable(r,l,c,t)}}}return{element:s,uncontrolled:n}},i.prototype.acceptElement=function(e,t){var i,n,o=this._props,s=o.memorizeCurrent,a=o.visibilityAware;if(s||a){var u=this.getElement();if(u){if(s){var l=null===(i=this._current)||void 0===i?void 0:i.get();if(l&&t.acceptCondition(l)&&t.from&&!u.contains(t.from))return t.found=!0,t.foundElement=l,NodeFilter.FILTER_ACCEPT}if(a&&!u.contains(t.from)){var c=Object.keys(this._visible),d=void 0;t.isForward||c.reverse();for(var _=0,f=c;_<f.length;_++){var h=f[_],v=this._visible[h];if((v===r.Visible||v===r.PartiallyVisible&&(a===r.PartiallyVisible||!this._hasFullyVisible))&&(d=null===(n=this._focusables[h])||void 0===n?void 0:n.get())&&t.acceptCondition(d))return t.found=!0,t.foundElement=d,NodeFilter.FILTER_ACCEPT}}}}},i.prototype._observeState=function(){var e=this,t=this.getElement();if(!this._unobserve&&t&&"undefined"!=typeof MutationObserver){var i=new MutationObserver((function(){var t=e._win();e._domChangedTimer&&t.clearTimeout(e._domChangedTimer),e._domChangedTimer=t.setTimeout(e._domChanged,0)}));i.observe(t,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["tabindex"]}),this._unobserve=function(){i.disconnect()}}},i.prototype.forceUpdate=function(){this._processOnChange(!0)},i.prototype._processOnChange=function(e){var t=this;if(!this._onChangeTimer||e){var i=function(){t._onChangeTimer=void 0;var e=[];if(t._current!==t._prevCurrent&&(e.push(t._current),e.push(t._prevCurrent),t._prevCurrent=t._current),t._visible!==t._prevVisible){t._hasFullyVisible=!1;for(var i=0,n=Object.keys(t._visible);i<n.length;i++){var o=t._visible[d=n[i]];o!==t._prevVisible[d]&&e.push(t._focusables[d]),o===r.Visible&&(t._hasFullyVisible=!0)}for(var s=0,a=Object.keys(t._prevVisible);s<a.length;s++)t._visible[d=a[s]]!==t._prevVisible[d]&&e.push(t._focusables[d]);t._prevVisible=t._visible}for(var u={},l=0,c=e;l<c.length;l++){var d,_=c[l],f=null==_?void 0:_.get();if((d=f&&C(t._win,f))&&!u[d]&&(u[d]=!0,t._focusables[d])){var h=t._props;if(f&&(void 0!==h.visibilityAware||h.trackState)){var v=t.getState(f);v&&S(f,"tabster:mover",v)}}}};this._onChangeTimer&&this._win().clearTimeout(this._onChangeTimer),e?i():this._onChangeTimer=this._win().setTimeout(i,0)}},i.prototype.getState=function(e){var t=C(this._win,e);if(t in this._visible){var i=this._visible[t]||r.Invisible;return{isCurrent:this._current?this._current.get()===e:void 0,visibility:i}}},i.prototype.updateVisible=function(e){var t,i=this,n=this._element.get();if(!this._updateVisibleTimer&&n){if(e)for(var o=n.parentElement;o;o=o.parentElement){var s=null===(t=u(this._tabster,o))||void 0===t?void 0:t.mover;s&&s.updateVisible(!1)}this._updateVisibleTimer=this._win().setTimeout((function(){i._updateVisibleTimer=void 0;for(var e=!1,t={},n=0,o=Object.keys(i._focusables);n<o.length;n++){var s=o[n],a=i._focusables[s].get(),u=a?T(i._win,a,10):r.Invisible,l=i._visible[s]||r.Invisible;u!==r.Invisible&&(t[s]=u),l!==u&&(e=!0)}e&&(i._prevVisible=i._visible,i._visible=t,i._processOnChange())}),0)}},i}(M),Ie=function(){function e(e,i){var n=this;this._scrollTargets=[],this._init=function(){n._initTimer=void 0;var e=n._win();e.addEventListener("scroll",n._onScroll,!0),e.addEventListener("keydown",n._onKeyDown,!0)},this._onMoverDispose=function(e){delete n._movers[e.id]},this._onFocus=function(e){for(var t,i=e;i;i=i.parentElement){var r=null===(t=u(n._tabster,i))||void 0===t?void 0:t.mover;if(r){r.setCurrent(e);break}}},this._onScroll=function(e){for(var t=!1,i=0,r=n._scrollTargets;i<r.length;i++)if(r[i]===e.target){t=!0;break}!t&&e.target.contains&&n._scrollTargets.push(e.target);var o=n._win();n._scrollTimer&&o.clearTimeout(n._scrollTimer),n._scrollTimer=o.setTimeout((function(){n._scrollTimer=void 0,n._updateVisible(n._scrollTargets),n._scrollTargets=[]}),200)},this._onKeyDown=function(e){var i,r,s=e.keyCode;switch(s){case 40:case 39:case 38:case 37:case 34:case 33:case 36:case 35:case 9:break;default:return}var a=n._tabster,u=a.focusedElement.getFocusedElement();if(u&&!n._isIgnoredInput(u,s)){var l=V.getTabsterContext(a,u,{checkRtl:!0});if(l&&l.mover&&!(l.isGroupperFirst&&l.groupper&&l.groupper.isActive())){var c=l.mover,d=c.getElement();if(d){var _,f=a.focusable,h=c.getProps(),v=h.direction||o.Both,p=v===o.Both,m=p||v===o.Vertical,b=p||v===o.Horizontal,g=v===o.Grid,y=h.cyclic;if(!h.disableHomeEndKeys||36!==s&&35!==s){if(l.isRtl&&(39===s?s=37:37===s&&(s=39)),40===s&&m||39===s&&b)!(_=f.findNext({currentElement:u,container:d}))&&y&&(_=f.findFirst({container:d}));else if(38===s&&m||37===s&&b)!(_=f.findPrev({currentElement:u,container:d}))&&y&&(_=f.findLast({container:d}));else if(36===s)_=f.findFirst({container:d});else if(35===s)_=f.findLast({container:d});else if(33===s){for(var T=f.findPrev({currentElement:u,container:d}),F=null;T;)F=T,T=w(n._win,T)?f.findPrev({currentElement:T,container:d}):null;(_=F)&&E(n._win,_,!1)}else if(34===s){for(var D=f.findNext({currentElement:u,container:d}),I=null;D;)I=D,D=w(n._win,D)?f.findNext({currentElement:D,container:d}):null;(_=I)&&E(n._win,_,!0)}else if(9!==s||a.controlTab){if(g){for(var C=u.getBoundingClientRect(),k=void 0,O=void 0,R=40===s||39===s?"findNext":"findPrev",N=f[R]({currentElement:u,container:d});N;N=f[R]({currentElement:N,container:d})){var x=N.getBoundingClientRect();if(38===s){if(x.top<C.top){if(void 0===O)O=x.top;else if(x.top<O)break;if(x.left<C.left){_||(_=N);break}_=N}}else if(40===s){if(x.top>C.top){if(void 0===O)O=x.top;else if(x.top>O)break;if(x.left>C.left){_||(_=N);break}_=N}}else if(37===s||39===s){_=N;break}k=N}_||(_=k)}}else _=null===(i=ve.findNextTabbable(a,l,u,e.shiftKey))||void 0===i?void 0:i.element;_?(e.preventDefault(),e.stopImmediatePropagation(),t.nativeFocus(_)):9===s&&(null===(r=c._dummyManagner)||void 0===r||r.moveOutWithDefaultAction(e.shiftKey))}}}}},this._tabster=e,this._win=i,this._initTimer=i().setTimeout(this._init,0),this._movers={},e.focusedElement.subscribe(this._onFocus)}return e.prototype.dispose=function(){var e=this,t=this._win();this._tabster.focusedElement.unsubscribe(this._onFocus),this._initTimer&&(t.clearTimeout(this._initTimer),this._initTimer=void 0),this._scrollTimer&&(t.clearTimeout(this._scrollTimer),this._scrollTimer=void 0),t.removeEventListener("scroll",this._onScroll,!0),this._scrollTargets=[],t.removeEventListener("keydown",this._onKeyDown,!0),Object.keys(this._movers).forEach((function(t){e._movers[t]&&(e._movers[t].dispose(),delete e._movers[t])}))},e.dispose=function(e){e.dispose()},e.prototype._updateVisible=function(e){for(var t={},i=0,n=e;i<n.length;i++)for(var r=n[i],o=0,s=Object.keys(this._movers);o<s.length;o++){var a=this._movers[s[o]],u=a.getElement();u&&r.contains(u)&&(t[a.id]=a)}for(var l=0,c=Object.keys(t);l<c.length;l++)t[c[l]].updateVisible(!1)},e.prototype._isIgnoredInput=function(e,t){if(N(e,Ee)&&("INPUT"===e.tagName||"TEXTAREA"===e.tagName)){var i=e.selectionStart||0;if(i!==(e.selectionEnd||0))return!0;if(i>0&&(37===t||38===t||36===t))return!0;if(i<(e.value||"").length&&(39===t||40===t||35===t))return!0}return!1},e.createMover=function(e,t,i){var n=e.mover,r=new De(e,t,n._onMoverDispose,i);return n._movers[r.id]=r,r},e}(),Ce=function(t){function n(e){var i=t.call(this)||this;return i._waiting={},i._lastRequestFocusId=0,i._observedById={},i._observedByName={},i._currentRequestTimestamp=0,i._init=function(){i._initTimer=void 0,i._tabster.focusedElement.subscribe(i._onFocus)},i._onFocus=function(e){if(e){var t=i._currentRequest;t&&Date.now()-i._currentRequestTimestamp>=300&&(delete i._currentRequest,t.cancel())}},i.onObservedElementUpdate=function(e){var t,n=null===(t=u(i._tabster,e))||void 0===t?void 0:t.observed,r=C(i._win,e),o=i._observedById[r];if(n&&R(e.ownerDocument,e)){o||(o=i._observedById[r]={element:new m(i._win,e)});var s=n.name;if(s!==(l=o.prevName)){if(l){var a=i._observedByName[l];a&&a[r]&&(Object.keys(a).length>1?delete a[r]:delete i._observedByName[l])}o.prevName=s}(c=i._observedByName[s])||(c=i._observedByName[s]={}),c[r]=o,i._waitConditional(s)}else if(o){var l,c;(l=o.prevName)&&(c=i._observedByName[l])&&c[r]&&(Object.keys(c).length>1?delete c[r]:delete i._observedByName[l]),delete i._observedById[r]}},i._tabster=e,i._win=e.getWindow,i._initTimer=i._win().setTimeout(i._init,0),i}return e.__extends(n,t),n.prototype.dispose=function(){var e=this._win();this._initTimer&&(e.clearTimeout(this._initTimer),this._initTimer=void 0),this._tabster.focusedElement.unsubscribe(this._onFocus);for(var t=0,i=Object.keys(this._waiting);t<i.length;t++)this._rejectWaiting(i[t]);this._observedById={},this._observedByName={}},n.prototype._rejectWaiting=function(e,t){var i=this._waiting[e];if(i){var n=this._win();i.timer&&n.clearTimeout(i.timer),i.conditionTimer&&n.clearTimeout(i.conditionTimer),!t&&i.reject?i.reject():t&&i.resolve&&i.resolve(null),delete this._waiting[e]}},n.dispose=function(e){e.dispose()},n.prototype.getElement=function(e,t){var n=this._observedByName[e];if(n)for(var r=0,o=Object.keys(n);r<o.length;r++){var s=o[r],a=n[s].element.get()||null;return a?(t===i.Accessible&&!this._tabster.focusable.isAccessible(a)||t===i.Focusable&&!this._tabster.focusable.isFocusable(a,!0))&&(a=null):(delete n[s],delete this._observedById[s]),a}return null},n.prototype.waitElement=function(e,t,n){var r=this,o=this.getElement(e,n);if(o)return{result:x(this._win).resolve(o),cancel:function(){}};var s=(n===i.Accessible?"a":n===i.Focusable?"f":"_")+e,a=this._waiting[s];if(a&&a.request)return a.request;a=this._waiting[s]={timer:this._win().setTimeout((function(){a.conditionTimer&&r._win().clearTimeout(a.conditionTimer),delete r._waiting[s],a.resolve&&a.resolve(null)}),t)};var u=new(x(this._win))((function(e,t){a.resolve=e,a.reject=t}));return a.request={result:u,cancel:function(){r._rejectWaiting(s,!0)}},n&&this.getElement(e)&&this._waitConditional(e),a.request},n.prototype.requestFocus=function(e,t){var n=this,r=++this._lastRequestFocusId,o=this._currentRequest;o&&o.cancel();var s=this.waitElement(e,t,i.Focusable);return this._currentRequest=s,this._currentRequestTimestamp=Date.now(),s.result.finally((function(){n._currentRequest===s&&delete n._currentRequest})),{result:s.result.then((function(e){return!(n._lastRequestFocusId!==r||!e)&&n._tabster.focusedElement.focus(e,!0)})),cancel:function(){s.cancel()}}},n.prototype._waitConditional=function(e){var t=this,n="_"+e,r="a"+e,o="f"+e,s=this._waiting[n],a=this._waiting[r],l=this._waiting[o],c=this._win(),d=function(i,n,r,o){var s,a=null===(s=u(t._tabster,i))||void 0===s?void 0:s.observed;a&&a.name===e&&(r.timer&&c.clearTimeout(r.timer),delete t._waiting[n],r.resolve&&r.resolve(i),t.trigger(i,{name:e,details:a.details,accessibility:o}))};if(s){var _=this.getElement(e);_&&R(_.ownerDocument,_)&&d(_,n,s,i.Any)}a&&!a.conditionTimer&&function n(){var o=t.getElement(e);o&&R(o.ownerDocument,o)&&t._tabster.focusable.isAccessible(o)?d(o,r,a,i.Accessible):a.conditionTimer=c.setTimeout(n,100)}(),l&&!l.conditionTimer&&function n(){var r=t.getElement(e);r&&R(r.ownerDocument,r)&&t._tabster.focusable.isFocusable(r,!0)?d(r,o,l,i.Focusable):l.conditionTimer=c.setTimeout(n,100)}()},n}(d),ke={areaClass:"tabster-focus-outline-area",outlineClass:"tabster-focus-outline",outlineColor:"#ff4500",outlineWidth:2,zIndex:2147483647},Oe=ke;"undefined"!=typeof document&&("onfullscreenchange"in document?(de="fullscreenchange",_e="fullscreenElement"):"onwebkitfullscreenchange"in document?(de="webkitfullscreenchange",_e="webkitFullscreenElement"):"onmozfullscreenchange"in document?(de="mozfullscreenchange",_e="mozFullScreenElement"):"onmsfullscreenchange"in document&&(de="msfullscreenchange",_e="msFullscreenElement"));var Re=function(){function e(e,t,i,n){this.left=e,this.top=t,this.right=i,this.bottom=n}return e.prototype.equalsTo=function(e){return this.left===e.left&&this.top===e.top&&this.right===e.right&&this.bottom===e.bottom},e.prototype.clone=function(){return new e(this.left,this.top,this.right,this.bottom)},e}(),Ne=function(){function t(e){var i=this;this._isVisible=!1,this._allOutlineElements=[],this._init=function(){i._initTimer=void 0,i._tabster.keyboardNavigation.subscribe(i._onKeyboardNavigationStateChanged),i._tabster.focusedElement.subscribe(i._onFocus);var e=i._win();e.addEventListener("scroll",i._onScroll,!0),de&&e.document.addEventListener(de,i._onFullScreenChanged)},this._onFullScreenChanged=function(e){if(_e&&e.target){var t=e.target.body||e.target,n=i._getDOM(t);if(t.ownerDocument&&n){var r=t.ownerDocument[_e];r?(r.appendChild(n.container),i._fullScreenElement=r):(t.ownerDocument.body.appendChild(n.container),i._fullScreenElement=void 0)}}},this._onKeyboardNavigationStateChanged=function(){i._onFocus(i._tabster.focusedElement.getFocusedElement())},this._onFocus=function(e){!i._updateElement(e)&&i._isVisible&&i._setVisibility(!1)},this._onScroll=function(e){i._outlinedElement&&t._isParentChild(e.target,i._outlinedElement)&&(i._curPos=void 0,i._setOutlinePosition())},this._tabster=e,this._win=e.getWindow,this._initTimer=this._win().setTimeout(this._init,0)}return t.prototype.setup=function(t){Oe=e.__assign(e.__assign({},Oe),t);var i=this._win();i.__tabsterOutline||(i.__tabsterOutline={}),i.__tabsterOutline.style||(i.__tabsterOutline.style=xe(i.document,Oe)),t&&t.areaClass?i.document.body.classList.remove(ke.areaClass):i.document.body.classList.add(ke.areaClass)},t.prototype.dispose=function(){var e=this,t=this._win();this._initTimer&&(t.clearTimeout(this._initTimer),this._initTimer=void 0),this._updateTimer&&(t.clearTimeout(this._updateTimer),this._updateTimer=void 0),this._tabster.keyboardNavigation.unsubscribe(this._onKeyboardNavigationStateChanged),this._tabster.focusedElement.unsubscribe(this._onFocus),t.removeEventListener("scroll",this._onScroll,!0),de&&t.document.removeEventListener(de,this._onFullScreenChanged),this._allOutlineElements.forEach((function(t){return e._removeDOM(t.container)})),this._allOutlineElements=[],delete this._outlinedElement,delete this._curPos,delete this._curOutlineElements,delete this._fullScreenElement},t.dispose=function(e){e.dispose()},t.prototype._shouldShowCustomOutline=function(e){var t=u(this._tabster,e);if(t&&t.outline&&t.outline.isIgnored)return!1;for(var i=e;i;i=i.parentElement)if(i.classList&&i.classList.contains(Oe.areaClass))return!0;return!1},t.prototype._updateElement=function(e){if(this._outlinedElement=void 0,this._updateTimer&&(this._win().clearTimeout(this._updateTimer),this._updateTimer=void 0),this._curPos=void 0,!this._tabster.keyboardNavigation.isNavigatingWithKeyboard())return!1;if(e){if("INPUT"===e.tagName){if(!(e.type in{button:!0,checkbox:!0,file:!0,image:!0,radio:!0,range:!0,reset:!0,submit:!0}))return!1}else if("TEXTAREA"===e.tagName||"true"===e.contentEditable||"IFRAME"===e.tagName)return!1;return!!this._shouldShowCustomOutline(e)&&(this._tabster.keyboardNavigation.isNavigatingWithKeyboard()&&(this._outlinedElement=e,this._updateOutline()),!0)}return!1},t.prototype._updateOutline=function(){var e=this;this._setOutlinePosition(),this._updateTimer&&(this._win().clearTimeout(this._updateTimer),this._updateTimer=void 0),this._outlinedElement&&(this._updateTimer=this._win().setTimeout((function(){e._updateTimer=void 0,e._updateOutline()}),30))},t.prototype._setVisibility=function(e){this._isVisible=e,this._curOutlineElements&&(e?this._curOutlineElements.container.classList.add(Oe.outlineClass+"_visible"):(this._curOutlineElements.container.classList.remove(Oe.outlineClass+"_visible"),this._curPos=void 0))},t.prototype._setOutlinePosition=function(){if(this._outlinedElement){var e=y(this._win,this._outlinedElement),t=new Re(e.left,e.top,e.right,e.bottom);if(!this._curPos||!t.equalsTo(this._curPos)){var i=this._getDOM(this._outlinedElement),n=this._outlinedElement.ownerDocument&&this._outlinedElement.ownerDocument.defaultView;if(i&&n){this._curOutlineElements!==i&&(this._setVisibility(!1),this._curOutlineElements=i),this._curPos=t;var r=t.clone(),o=!1,s=!1,a=i.container,u=a&&a.ownerDocument&&a.ownerDocument.scrollingElement;if(u){for(var l=this._outlinedElement.parentElement;l&&l!==this._fullScreenElement;l=l.parentElement){e=y(this._win,l);var c=l.ownerDocument&&l.ownerDocument.defaultView;if(!c)return;var d=c.getComputedStyle(l),_=d.position;"absolute"===_?o=!0:"fixed"!==_&&"sticky"!==_||(s=!0),"visible"!==d.overflow&&((o||s)&&"hidden"!==d.overflow||(e.left>r.left&&(r.left=e.left),e.top>r.top&&(r.top=e.top),e.right<r.right&&(r.right=e.right),e.bottom<r.bottom&&(r.bottom=e.bottom)))}var f=y(this._win,u),h=f.left+f.right,v=f.top+f.bottom,p=Oe.outlineWidth;r.left=r.left>p?r.left-p:0,r.top=r.top>p?r.top-p:0,r.right=r.right<h-p?r.right+p:h,r.bottom=r.bottom<v-p?r.bottom+p:v;var m=r.right-r.left,b=r.bottom-r.top;if(m>2*p&&b>2*p){var g=i.left,w=i.top,T=i.right,E=i.bottom,F=this._fullScreenElement||s?0:n.pageXOffset,D=this._fullScreenElement||s?0:n.pageYOffset;a.style.position=s?"fixed":"absolute",a.style.background=Oe.outlineColor,g.style.width=T.style.width=w.style.height=E.style.height=Oe.outlineWidth+"px",g.style.left=w.style.left=E.style.left=r.left+F+"px",T.style.left=r.left+F+m-p+"px",g.style.top=T.style.top=w.style.top=r.top+D+"px",E.style.top=r.top+D+b-p+"px",g.style.height=T.style.height=b+"px",w.style.width=E.style.width=m+"px",this._setVisibility(!0)}else this._setVisibility(!1)}}}}},t.prototype._getDOM=function(e){var t=e.ownerDocument,i=t&&t.defaultView;if(t&&i&&i.__tabsterOutline){if(i.__tabsterOutline.style||(i.__tabsterOutline.style=xe(t,Oe)),!i.__tabsterOutline.elements){var n={container:t.createElement("div"),left:t.createElement("div"),top:t.createElement("div"),right:t.createElement("div"),bottom:t.createElement("div")};n.container.className=Oe.outlineClass,n.left.className=Oe.outlineClass+"__left",n.top.className=Oe.outlineClass+"__top",n.right.className=Oe.outlineClass+"__right",n.bottom.className=Oe.outlineClass+"__bottom",n.container.appendChild(n.left),n.container.appendChild(n.top),n.container.appendChild(n.right),n.container.appendChild(n.bottom),t.body.appendChild(n.container),i.__tabsterOutline.elements=n,this._allOutlineElements.push(n)}return i.__tabsterOutline.elements}},t.prototype._removeDOM=function(e){var t=e.ownerDocument&&e.ownerDocument.defaultView,i=t&&t.__tabsterOutline;if(i){i.style&&i.style.parentNode&&(i.style.parentNode.removeChild(i.style),delete i.style);var n=i&&i.elements;n&&(n.container.parentNode&&n.container.parentNode.removeChild(n.container),delete i.elements)}},t._isParentChild=function(e,t){return t===e||!!(e.compareDocumentPosition(t)&document.DOCUMENT_POSITION_CONTAINED_BY)},t}();function xe(e,t){var i=e.createElement("style");return i.type="text/css",i.appendChild(e.createTextNode(function(e){return"\n."+e.areaClass+" *, ."+e.areaClass+" *:focus {\noutline: none !important;\n}\n\n."+e.outlineClass+" {\ndisplay: none;\nposition: absolute;\nwidth: 0;\nheight: 0;\nleft: 0;\ntop: 0;\nz-index: "+e.zIndex+";\n}\n\n."+e.outlineClass+"."+e.outlineClass+"_visible {\ndisplay: block;\n}\n\n."+e.outlineClass+"__left,\n."+e.outlineClass+"__top,\n."+e.outlineClass+"__right,\n."+e.outlineClass+"__bottom {\nposition: absolute;\nbackground: inherit;\n}"}(t))),e.head.appendChild(i),i}var Ae=function(){return function(e){}}(),Me=function(){function e(e,t){var i,n=this;this._forgetMemorizedElements=[],this._version="1.0.7",this._noop=!1,this.getWindow=function(){if(!n._win)throw new Error("Using disposed Tabster.");return n._win},this._storage=function(e){var t=e.__tabsterInstanceContext;return new((null==t?void 0:t.basics.WeakMap)||WeakMap)}(e),this._win=e;var r=this.getWindow;this.keyboardNavigation=new _(r),this.focusedElement=new ve(this,r),this.focusable=new he(this,r),this.root=new V(this,null==t?void 0:t.autoRoot),this.createRoot=V.createRoot,this.updateRoot=function(e,t){V.onRoot(n.root,e,t)},this.uncontrolled=new Ae(this),this.controlTab=null===(i=null==t?void 0:t.controlTab)||void 0===i||i,this.internal={stopObserver:function(){n._unobserve&&(n._unobserve(),delete n._unobserve)},resumeObserver:function(e){if(!n._unobserve){var t=r().document;n._unobserve=function(e,t,i,n){if("undefined"==typeof MutationObserver)return function(){};var r,o=t.getWindow;function s(t,i){r||(r=v(o).elementByUId),a(t,i);var n=g(e,t,(function(e){return a(e,i)}));if(n)for(;n.nextNode(););}function a(e,n){var s,a;if(!e.getAttribute)return NodeFilter.FILTER_SKIP;var l=e.__tabsterElementUID;return l&&(n?delete r[l]:null!==(s=(a=r)[l])&&void 0!==s||(a[l]=new m(o,e))),(u(t,e)||e.hasAttribute("data-tabster"))&&i(t,e,n),NodeFilter.FILTER_SKIP}var l=new MutationObserver((function(e){for(var n=0,r=e;n<r.length;n++){var o=r[n],a=o.removedNodes,u=o.addedNodes;if("attributes"===o.type)"data-tabster"===o.attributeName&&i(t,o.target);else{for(var l=0;l<a.length;l++)s(a[l],!0);for(l=0;l<u.length;l++)s(u[l])}}}));return n&&s(o().document.body),l.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["data-tabster"]}),function(){l.disconnect()}}(t,n,l,e)}}},this.internal.resumeObserver(!1),function e(t){var i=v(t);i.fakeWeakRefsStarted||(i.fakeWeakRefsStarted=!0,i.WeakRef=function(e){return e.basics.WeakRef}(i)),i.fakeWeakRefsTimer||(i.fakeWeakRefsTimer=t().setTimeout((function(){i.fakeWeakRefsTimer=void 0,b(t),e(t)}),12e4))}(r)}return e.prototype.dispose=function(){this.internal.stopObserver();var e=this._win;this._forgetMemorizedElements=[],e&&this._forgetMemorizedTimer&&(e.clearTimeout(this._forgetMemorizedTimer),delete this._forgetMemorizedTimer);for(var t,i,n={outlineDispose:["outline"],crossOriginDispose:["crossOrigin"],deloserDispose:["deloser","createDeloser"],groupperDispose:["groupper","createGroupper"],moverDispose:["mover","createMover"],modalizerDispose:["modalizer","createModalizer","updateModalizer"],observedElementDispose:["observedElement","updateObserved"]},r=0,o=Object.keys(n);r<o.length;r++){var s=o[r],a=this[s];if(a){a();for(var u=0,l=n[s];u<l.length;u++){var c=l[u];this[c]&&delete this[c]}delete this[s]}}_.dispose(this.keyboardNavigation),he.dispose(this.focusable),ve.dispose(this.focusedElement),V.dispose(this.root),(i=v(t=this.getWindow)).fakeWeakRefsStarted=!1,i.fakeWeakRefsTimer&&(t().clearTimeout(i.fakeWeakRefsTimer),i.fakeWeakRefsTimer=void 0,i.fakeWeakRefs=[]),O(this.getWindow),this._storage=new WeakMap,e&&(function(e){var t=e.__tabsterInstanceContext;t&&(t.elementByUId={},delete t.WeakRef,t.containerBoundingRectCache={},t.containerBoundingRectCacheTimer&&e.clearTimeout(t.containerBoundingRectCacheTimer),t.fakeWeakRefsTimer&&e.clearTimeout(t.fakeWeakRefsTimer),t.fakeWeakRefs=[],delete e.__tabsterInstanceContext)}(e),delete e.__tabsterInstance,delete this._win)},e.dispose=function(e){e.dispose()},e.prototype.storageEntry=function(e,t){var i=this._storage,n=i.get(e);return n?!1===t&&0===Object.keys(n).length&&i.delete(e):!0===t&&i.set(e,n={}),n},e.forceCleanup=function(e){e._win&&(e._forgetMemorizedElements.push(e._win.document.body),e._forgetMemorizedTimer||(e._forgetMemorizedTimer=e._win.setTimeout((function(){delete e._forgetMemorizedTimer;for(var t=e._forgetMemorizedElements.shift();t;t=e._forgetMemorizedElements.shift())O(e.getWindow,t),ve.forgetMemorized(e.focusedElement,t)}),0),b(e.getWindow,!0)))},e}();function Ue(e){var t=e;if(!t.groupper){var i=new be(e,t.getWindow);t.groupper=i,t.createGroupper=be.createGroupper,t.groupperDispose=function(){be.dispose(i)}}return t.groupper}function Pe(e){var t=e;if(!t.mover){var i=new Ie(e,t.getWindow);t.mover=i,t.createMover=Ie.createMover,t.moverDispose=function(){Ie.dispose(i)}}return t.mover}function ze(e){var t=e;if(!t.outline){var i=new Ne(e);t.outline=i,t.outlineDispose=function(){Ne.dispose(i)}}return t.outline}function Se(e,t){var i=e;if(!i.deloser){var n=new Y(e,t);i.deloser=n,i.createDeloser=Y.createDeloser,i.deloserDispose=function(){Y.dispose(n)}}return i.deloser}function We(e){var t=e;if(!t.modalizer){var i=new Te(e);t.modalizer=i,t.createModalizer=Te.createModalizer,t.updateModalizer=function(e,i){Te.updateModalizer(t,e,i)},t.modalizerDispose=function(){Te.dispose(i)}}return t.modalizer}function Le(e){var t=e;if(!t.observedElement){var i=new Ce(e);t.observedElement=i,t.updateObserved=i.onObservedElementUpdate,t.observedElementDispose=function(){Ce.dispose(i)}}return t.observedElement}function Ve(e,t){var i,n=JSON.stringify(e);return!0===t?n:((i={})["data-tabster"]=n,i)}function Be(e){return e.__tabsterInstance}exports.Types=a,exports.createTabster=function(e,t){var i=Be(e);if(i)return i;var n=new Me(e,t);return e.__tabsterInstance=n,n},exports.disposeTabster=function(e){Me.dispose(e)},exports.forceCleanup=function(e){Me.forceCleanup(e)},exports.getCrossOrigin=function(e){var t=e;if(!t.crossOrigin){Se(e),We(e),Pe(e),Ue(e),ze(e),Le(e);var i=new le(e);t.crossOrigin=i,t.crossOriginDispose=function(){le.dispose(i)}}return t.crossOrigin},exports.getCurrentTabster=Be,exports.getDeloser=Se,exports.getGroupper=Ue,exports.getInternal=function(e){return e.internal},exports.getModalizer=We,exports.getMover=Pe,exports.getObservedElement=Le,exports.getOutline=ze,exports.getTabsterAttribute=Ve,exports.isNoOp=function(e){return e._noop},exports.makeNoOp=function(e,t){var i=e;if(i._noop!==t){i._noop=t;var n=function(e){return e.getAttribute?((u(i,e)||e.hasAttribute("data-tabster"))&&l(i,e),NodeFilter.FILTER_SKIP):NodeFilter.FILTER_SKIP},r=i.getWindow().document,o=r.body;n(o);var s=g(r,o,n);if(s)for(;s.nextNode(););}},exports.overrideBasics=function(e,t){var i,n=v((function(){return e}));(i="Promise")in t&&(n.basics[i]=t[i]),(i="WeakRef")in t&&(n.basics[i]=t[i]),(i="WeakMap")in t&&(n.basics[i]=t[i])},exports.setTabsterAttribute=function(e,t,i){var n;if(i){var r=e.getAttribute("data-tabster");if(r)try{n=JSON.parse(r)}catch(e){}}i&&n||(n={});for(var o=0,s=Object.keys(t);o<s.length;o++){var a=s[o],u=t[a];u?n[a]=u:delete n[a]}Object.keys(n).length>0?e.setAttribute("data-tabster",Ve(n,!0)):e.removeAttribute("data-tabster")};
//# sourceMappingURL=tabster.cjs.production.min.js.map
